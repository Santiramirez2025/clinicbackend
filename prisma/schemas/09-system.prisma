// ============================================================================
// üìä DOMINIO: SISTEMA - ANALYTICS, AUDIT Y CONFIGURACI√ìN
// ============================================================================
// Modelos incluidos: AuditLog, AnalyticsEvent, BusinessMetric, SystemConfig, FeatureFlag
// Dependencias: 02-auth.prisma (User, Professional), 03-clinic.prisma (Clinic)
// √öltima actualizaci√≥n: 2025-08-20
// ============================================================================

// ============================================================================
// üõ°Ô∏è MODELO AUDIT LOG - TRAZABILIDAD COMPLETA
// ============================================================================

/// Registro de auditor√≠a para compliance y seguridad
/// Trazabilidad completa de todas las acciones cr√≠ticas del sistema
model AuditLog {
  /// Identificador √∫nico del log
  id String @id @default(cuid())

  // ‚úÖ ACTOR QUE REALIZ√ì LA ACCI√ìN
  userId         String? @map("user_id")
  professionalId String? @map("professional_id")
  clinicId       String? @map("clinic_id")
  actorType      String  @map("actor_type") @db.VarChar(20) // USER, PROFESSIONAL, SYSTEM
  actorEmail     String? @map("actor_email") @db.VarChar(100)

  // ‚úÖ ACCI√ìN REALIZADA
  action     String @db.VarChar(50) // CREATE, UPDATE, DELETE, LOGIN, EXPORT
  resource   String @db.VarChar(50) // USER, APPOINTMENT, PAYMENT, TREATMENT
  resourceId String? @map("resource_id") @db.VarChar(50)

  // ‚úÖ DETALLES DE LA ACCI√ìN
  description String? @db.Text
  changes     String? @db.Text // JSON con cambios espec√≠ficos
  oldValues   String? @map("old_values") @db.Text // JSON valores anteriores
  newValues   String? @map("new_values") @db.Text // JSON valores nuevos

  // ‚úÖ CONTEXTO T√âCNICO
  ipAddress String? @map("ip_address") @db.VarChar(45)
  userAgent String? @map("user_agent") @db.Text
  platform  String? @db.VarChar(20)
  sessionId String? @map("session_id") @db.VarChar(50)

  // ‚úÖ METADATA CONTEXTUAL
  severity String  @default("INFO") @db.VarChar(10) // DEBUG, INFO, WARN, ERROR, CRITICAL
  category String? @db.VarChar(30) // SECURITY, BUSINESS, SYSTEM, GDPR
  tags     String? @db.Text // JSON array de tags para filtrado

  // ‚úÖ COMPLIANCE Y LEGAL
  gdprRelevant    Boolean @default(false) @map("gdpr_relevant")
  retentionPolicy String? @map("retention_policy") @db.VarChar(20)
  
  // ‚úÖ INFORMACI√ìN ADICIONAL DE SEGURIDAD
  riskLevel       String? @map("risk_level") @db.VarChar(10) // LOW, MEDIUM, HIGH
  requiresReview  Boolean @default(false) @map("requires_review")
  reviewedBy      String? @map("reviewed_by")
  reviewedAt      DateTime? @map("reviewed_at")

  // Timestamp inmutable
  createdAt DateTime @default(now()) @map("created_at")

  // ‚úÖ √çNDICES PARA QUERIES DE AUDITOR√çA
  @@index([userId, action], map: "idx_audit_user_action")
  @@index([professionalId, action], map: "idx_audit_professional_action")
  @@index([clinicId, action], map: "idx_audit_clinic_action")
  @@index([resource, resourceId], map: "idx_audit_resource")
  @@index([createdAt], map: "idx_audit_date")
  @@index([severity, category], map: "idx_audit_severity")
  @@index([gdprRelevant], map: "idx_audit_gdpr")
  @@index([riskLevel, requiresReview], map: "idx_audit_security")
  @@map("audit_logs")
}

// ============================================================================
// üìà MODELO ANALYTICS EVENT - EVENTOS DE USUARIO
// ============================================================================

/// Evento de analytics para tracking de comportamiento
/// Sistema completo de analytics con contexto enriquecido
model AnalyticsEvent {
  /// Identificador √∫nico del evento
  id       String @id @default(cuid())
  userId   String? @map("user_id")
  clinicId String? @map("clinic_id")
  sessionId String? @map("session_id") @db.VarChar(50)

  // ‚úÖ INFORMACI√ìN DEL EVENTO
  eventName String @map("event_name") @db.VarChar(50)
  eventType String @map("event_type") @db.VarChar(30) // USER_ACTION, SYSTEM_EVENT, BUSINESS
  category  String? @db.VarChar(30)

  // ‚úÖ PROPIEDADES DEL EVENTO
  properties String? @db.Text // JSON con propiedades espec√≠ficas
  value      Decimal? @db.Decimal(10,2) // Valor monetario si aplica
  
  // ‚úÖ CONTEXTO DEL USUARIO
  userType      String? @map("user_type") @db.VarChar(20)
  loyaltyTier   String? @map("loyalty_tier") @db.VarChar(20)
  isVip         Boolean? @map("is_vip")
  userSegment   String? @map("user_segment") @db.VarChar(30)

  // ‚úÖ CONTEXTO T√âCNICO
  platform      String? @db.VarChar(20)
  deviceType    String? @map("device_type") @db.VarChar(20)
  appVersion    String? @map("app_version") @db.VarChar(20)
  screenName    String? @map("screen_name") @db.VarChar(50)

  // ‚úÖ CONTEXTO TEMPORAL
  dayOfWeek     Int? @map("day_of_week") // 1-7
  hourOfDay     Int? @map("hour_of_day") // 0-23
  isWeekend     Boolean? @map("is_weekend")
  timeZone      String? @map("time_zone") @db.VarChar(50)

  // ‚úÖ GEOLOCALIZACI√ìN
  country       String? @db.VarChar(2)
  city          String? @db.VarChar(50)
  ipAddress     String? @map("ip_address") @db.VarChar(45)

  // ‚úÖ CONTEXTO DE NEGOCIO
  funnel        String? @db.VarChar(30) // ACQUISITION, ACTIVATION, RETENTION
  touchpoint    String? @db.VarChar(30) // APP, EMAIL, SMS, WEB
  campaign      String? @db.VarChar(50)
  source        String? @db.VarChar(30)
  medium        String? @db.VarChar(30)

  // Timestamp
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, eventName], map: "idx_analytics_user_event")
  @@index([clinicId, eventName], map: "idx_analytics_clinic_event")
  @@index([eventName, createdAt], map: "idx_analytics_event_time")
  @@index([createdAt], map: "idx_analytics_date")
  @@index([userSegment, eventType], map: "idx_analytics_segment")
  @@index([funnel, touchpoint], map: "idx_analytics_funnel")
  @@map("analytics_events")
}

// ============================================================================
// üìä MODELO BUSINESS METRICS - M√âTRICAS DE NEGOCIO
// ============================================================================

/// M√©tricas agregadas de negocio para reporting ejecutivo
/// KPIs consolidados por per√≠odo para an√°lisis de tendencias
model BusinessMetric {
  /// Identificador √∫nico de la m√©trica
  id       String @id @default(cuid())
  clinicId String @map("clinic_id")
  
  // ‚úÖ PER√çODO DE MEDICI√ìN
  metricDate   DateTime @map("metric_date") @db.Date
  metricPeriod String   @map("metric_period") @db.VarChar(10) // DAILY, WEEKLY, MONTHLY
  
  // ‚úÖ M√âTRICAS DE CITAS
  totalAppointments     Int @default(0) @map("total_appointments")
  completedAppointments Int @default(0) @map("completed_appointments")
  cancelledAppointments Int @default(0) @map("cancelled_appointments")
  noShowAppointments    Int @default(0) @map("no_show_appointments")
  
  // ‚úÖ M√âTRICAS DE REVENUE
  totalRevenue      Decimal @default(0) @map("total_revenue") @db.Decimal(10,2)
  vipRevenue        Decimal @default(0) @map("vip_revenue") @db.Decimal(10,2)
  avgRevenuePerUser Decimal @default(0) @map("avg_revenue_per_user") @db.Decimal(8,2)
  avgOrderValue     Decimal @default(0) @map("avg_order_value") @db.Decimal(8,2)
  
  // ‚úÖ M√âTRICAS DE USUARIOS
  newUsers       Int @default(0) @map("new_users")
  activeUsers    Int @default(0) @map("active_users")
  returningUsers Int @default(0) @map("returning_users")
  churnedUsers   Int @default(0) @map("churned_users")
  
  // ‚úÖ M√âTRICAS DE CONVERSI√ìN
  signupConversion   Decimal @default(0) @map("signup_conversion") @db.Decimal(5,4)
  bookingConversion  Decimal @default(0) @map("booking_conversion") @db.Decimal(5,4)
  vipConversion      Decimal @default(0) @map("vip_conversion") @db.Decimal(5,4)
  retentionRate      Decimal @default(0) @map("retention_rate") @db.Decimal(5,4)
  
  // ‚úÖ M√âTRICAS DE SATISFACCI√ìN
  avgRating          Decimal? @map("avg_rating") @db.Decimal(3,2)
  npsScore           Decimal? @map("nps_score") @db.Decimal(5,2)
  reviewCount        Int @default(0) @map("review_count")
  satisfactionScore  Decimal? @map("satisfaction_score") @db.Decimal(3,2)
  
  // ‚úÖ M√âTRICAS OPERACIONALES
  utilizationRate    Decimal @default(0) @map("utilization_rate") @db.Decimal(5,4)
  punctualityRate    Decimal @default(0) @map("punctuality_rate") @db.Decimal(5,4)
  professionalEfficiency Decimal @default(0) @map("professional_efficiency") @db.Decimal(5,4)
  
  // ‚úÖ M√âTRICAS DE MARKETING
  acquisitionCost    Decimal @default(0) @map("acquisition_cost") @db.Decimal(8,2)
  marketingROI       Decimal @default(0) @map("marketing_roi") @db.Decimal(8,4)
  referralRate       Decimal @default(0) @map("referral_rate") @db.Decimal(5,4)
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@unique([clinicId, metricDate, metricPeriod], map: "unique_clinic_metric_period")
  @@index([clinicId, metricPeriod], map: "idx_clinic_metrics")
  @@index([metricDate], map: "idx_metric_date")
  @@index([metricPeriod, metricDate], map: "idx_metric_period_date")
  @@map("business_metrics")
}

// ============================================================================
// üîß MODELO SYSTEM CONFIG - CONFIGURACI√ìN DEL SISTEMA
// ============================================================================

/// Configuraci√≥n global del sistema con validaci√≥n
/// Permite configurar comportamientos sin deployments
model SystemConfig {
  /// Identificador √∫nico de la configuraci√≥n
  id    String @id @default(cuid())
  key   String @unique @db.VarChar(100)
  value String @db.Text
  type  String @db.VarChar(20) // STRING, NUMBER, BOOLEAN, JSON
  
  // ‚úÖ METADATA DESCRIPTIVA
  description String? @db.Text
  category    String? @db.VarChar(30)
  isPublic    Boolean @default(false) @map("is_public")
  isEditable  Boolean @default(true) @map("is_editable")
  
  // ‚úÖ VALIDACI√ìN Y CONSTRAINTS
  validationRules String? @map("validation_rules") @db.Text // JSON
  defaultValue    String? @map("default_value") @db.Text
  allowedValues   String? @map("allowed_values") @db.Text // JSON array
  
  // ‚úÖ CONFIGURACI√ìN DE ENTORNO
  environment     String @default("production") @db.VarChar(20)
  requiresRestart Boolean @default(false) @map("requires_restart")
  
  // ‚úÖ AUDIT Y TRACKING
  lastModifiedBy  String? @map("last_modified_by")
  changeReason    String? @map("change_reason") @db.Text
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@index([category], map: "idx_config_category")
  @@index([isPublic], map: "idx_config_public")
  @@index([environment], map: "idx_config_environment")
  @@map("system_configs")
}

// ============================================================================
// üö© MODELO FEATURE FLAG - CONTROL DE FEATURES
// ============================================================================

/// Sistema de feature flags para releases graduales
/// Control granular de funcionalidades por segmento de usuarios
model FeatureFlag {
  /// Identificador √∫nico del feature flag
  id          String @id @default(cuid())
  name        String @unique @db.VarChar(100)
  description String? @db.Text
  
  // ‚úÖ ESTADO Y CONFIGURACI√ìN
  isEnabled   Boolean @default(false) @map("is_enabled")
  environment String  @default("production") @db.VarChar(20)
  
  // ‚úÖ TARGETING GRANULAR
  targetUsers    String? @map("target_users") @db.Text // JSON array de user IDs
  targetClinics  String? @map("target_clinics") @db.Text // JSON array de clinic IDs
  targetPercent  Int?    @map("target_percent") // % de usuarios
  targetSegments String? @map("target_segments") @db.Text // JSON array
  
  // ‚úÖ CONFIGURACI√ìN AVANZADA
  config      String? @db.Text // JSON con configuraci√≥n espec√≠fica
  constraints String? @db.Text // JSON con constraints
  rolloutStrategy String? @map("rollout_strategy") @db.VarChar(20) // INSTANT, GRADUAL, CANARY
  
  // ‚úÖ VALIDEZ TEMPORAL
  validFrom   DateTime? @map("valid_from")
  validUntil  DateTime? @map("valid_until")
  
  // ‚úÖ ANALYTICS Y TRACKING
  usageCount     Int @default(0) @map("usage_count")
  lastUsedAt     DateTime? @map("last_used_at")
  conversionRate Decimal? @map("conversion_rate") @db.Decimal(5,4)
  
  // ‚úÖ METADATA Y OWNERSHIP
  owner       String? @db.VarChar(100)
  team        String? @db.VarChar(50)
  tags        String? @db.Text // JSON array
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@index([isEnabled, environment], map: "idx_feature_flag_enabled")
  @@index([validFrom, validUntil], map: "idx_feature_flag_validity")
  @@index([owner, team], map: "idx_feature_flag_ownership")
  @@map("feature_flags")
}

// ============================================================================
// üìä √çNDICES ESTRAT√âGICOS PARA SISTEMA Y ANALYTICS
// ============================================================================
// 
// 1. AUDITOR√çA Y COMPLIANCE:
//    - idx_audit_gdpr: Para reportes de compliance GDPR
//    - idx_audit_security: Para eventos de seguridad cr√≠ticos
//    - idx_audit_resource: Para trazabilidad por entidad
//
// 2. ANALYTICS Y BUSINESS INTELLIGENCE:
//    - idx_analytics_segment: Para an√°lisis por segmento de usuario
//    - idx_analytics_funnel: Para an√°lisis de embudo de conversi√≥n
//    - idx_metric_period_date: Para reportes ejecutivos
//
// 3. CONFIGURACI√ìN Y FEATURE FLAGS:
//    - idx_config_environment: Para configuraciones por entorno
//    - idx_feature_flag_enabled: Para evaluaci√≥n r√°pida de flags
//
// 4. PERFORMANCE CR√çTICA:
//    - idx_audit_date: Para limpieza de logs antiguos
//    - idx_analytics_date: Para particionado temporal
//
// QUERIES OPTIMIZADAS:
// - Reportes de auditor√≠a por usuario/acci√≥n
// - M√©tricas de negocio por per√≠odo
// - Evaluaci√≥n de feature flags
// - Analytics de comportamiento de usuario
// - Configuraci√≥n din√°mica del sistema
//
// ============================================================================

// ============================================================================
// üîö FIN DEL M√ìDULO DE SISTEMA
// ============================================================================
// Total de modelos: 5
// L√≠neas: ~280
// Funcionalidad: Analytics completo, auditor√≠a, configuraci√≥n y feature flags
// ============================================================================