// ============================================================================
// üè• BELLEZA EST√âTICA - SCHEMA GENERADO AUTOM√ÅTICAMENTE v4.0
// ============================================================================
// ‚ö†Ô∏è  NO EDITAR ESTE ARCHIVO DIRECTAMENTE
// Este archivo se genera autom√°ticamente desde los m√≥dulos en /schemas/
// Para hacer cambios, edita los archivos individuales y ejecuta: node merge-schema.js
// ============================================================================

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


// ============================================================================
// üìÅ M√ìDULO 1: 01-BASE
// ============================================================================

// ============================================================================
// üéØ DOMINIO: BASE - ENUMS GLOBALES Y TIPOS FUNDAMENTALES
// ============================================================================
// Modelos incluidos: Enums base para todo el sistema
// Dependencias: Ninguna (base del sistema)
// √öltima actualizaci√≥n: 2025-08-20
// ============================================================================

// ============================================================================
// ‚úÖ ENUMS DE CLASIFICACI√ìN LEGAL Y M√âDICA
// ============================================================================

/// Nivel de riesgo del tratamiento seg√∫n regulaci√≥n espa√±ola
/// Determina el tipo de consentimiento y profesional requerido
enum TreatmentRiskLevel {
  LOW       // Grupo A - Sin consulta previa obligatoria
  MEDIUM    // Grupo B - Consulta recomendada  
  HIGH      // Grupo B - Consulta obligatoria
  MEDICAL   // Grupo C - Solo personal m√©dico autorizado
}

/// Tipo de consentimiento requerido seg√∫n normativa sanitaria
/// Cada tipo tiene diferentes requisitos legales
enum ConsentType {
  SIMPLE    // Consentimiento b√°sico para tratamientos de bajo riesgo
  INFORMED  // Consentimiento informado con explicaci√≥n detallada
  MEDICAL   // Consentimiento m√©dico con validaci√≥n profesional
}

/// Flujo de cita seg√∫n tipo de tratamiento y compliance
/// Define el proceso de reserva y validaci√≥n m√©dica
enum AppointmentType {
  DIRECT                // Reserva directa sin consulta previa
  CONSULTATION_ONLY     // Solo consulta m√©dica
  CONSULTATION_TREATMENT // Consulta + Tratamiento mismo d√≠a
  CONSULTATION_SEPARATE  // Consulta previa obligatoria en cita separada
}

// ============================================================================
// üìÖ ENUMS DE ESTADO Y FLUJO DE NEGOCIO
// ============================================================================

/// Estados del ciclo de vida de una cita
/// Incluye estados para compliance y seguimiento legal
enum AppointmentStatus {
  PENDING      // Pendiente de confirmaci√≥n y validaci√≥n
  CONFIRMED    // Confirmada y lista para ejecuci√≥n
  IN_PROGRESS  // En progreso - tratamiento iniciado
  COMPLETED    // Completada exitosamente
  CANCELLED    // Cancelada por cliente o cl√≠nica
  NO_SHOW      // Cliente no se present√≥
  RESCHEDULED  // Reprogramada a nueva fecha
}

/// Roles y permisos en el sistema
/// Define niveles de acceso y funcionalidades
enum UserRole {
  CLIENT          // Cliente regular con acceso b√°sico
  VIP_CLIENT      // Cliente VIP con beneficios premium
  PROFESSIONAL    // Profesional que realiza tratamientos
  MANAGER         // Manager de cl√≠nica con permisos administrativos
  ADMIN           // Administrador del sistema con acceso completo
}

/// Estados de pago seg√∫n integraci√≥n con Stripe
/// Mapea directamente con estados de Stripe para consistencia
enum PaymentStatus {
  PENDING           // Pendiente de procesamiento
  PROCESSING        // Procesando en Stripe
  COMPLETED         // Completado exitosamente
  FAILED            // Fallido por error t√©cnico o rechazo
  CANCELLED         // Cancelado por usuario o sistema
  REFUNDED          // Reembolsado completamente
  PARTIALLY_REFUNDED // Reembolsado parcialmente
}

// ============================================================================
// üîî ENUMS DE COMUNICACI√ìN Y MARKETING
// ============================================================================

/// Tipos de notificaciones para engagement y compliance
/// Incluye notificaciones legales y de marketing
enum NotificationType {
  APPOINTMENT_REMINDER   // Recordatorio autom√°tico de cita
  APPOINTMENT_CONFIRMED  // Confirmaci√≥n de cita reservada
  PROMOTION             // Promoci√≥n comercial personalizada
  WELLNESS_TIP          // Consejo de bienestar y cuidado
  SYSTEM               // Notificaci√≥n del sistema
  BIRTHDAY             // Felicitaci√≥n de cumplea√±os
  VIP_OFFER            // Oferta exclusiva para clientes VIP
}

// ============================================================================
// üîö FIN DEL M√ìDULO BASE
// ============================================================================
// Total de enums: 7
// L√≠neas: ~80
// Funcionalidad: Tipos base para todo el sistema
// ============================================================================

// ============================================================================
// üìÅ M√ìDULO 2: 02-AUTH
// ============================================================================

// ============================================================================
// üîê DOMINIO: AUTENTICACI√ìN - USUARIOS, PROFESIONALES Y SESIONES
// ============================================================================
// Modelos incluidos: User, Professional, UserSession, PasswordResetToken, ProfessionalPasswordReset
// Dependencias: 01-base.prisma (enums)
// √öltima actualizaci√≥n: 2025-08-20
// ============================================================================

// ============================================================================
// üë§ MODELO USER - CLIENTE CON INFORMACI√ìN M√âDICA COMPLETA
// ============================================================================

/// Usuario principal del sistema - puede ser cliente regular o VIP
/// Incluye informaci√≥n m√©dica para compliance legal y GDPR
model User {
  /// Identificador √∫nico del usuario
  id           String    @id @default(cuid())
  
  // Datos de autenticaci√≥n
  email        String    @unique @db.VarChar(100)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  
  // Informaci√≥n personal b√°sica
  firstName    String    @map("first_name") @db.VarChar(50)
  lastName     String    @map("last_name") @db.VarChar(50)
  phone        String?   @db.VarChar(20)
  avatarUrl    String?   @map("avatar_url") @db.Text
  birthDate    DateTime? @map("birth_date") @db.Date
  gender       String?   @db.VarChar(20) // F, M, Other, PreferNotToSay

  // Cl√≠nica principal y rol
  primaryClinicId String   @map("primary_clinic_id")
  role            UserRole @default(CLIENT)
  permissions     String   @default("[]") @db.Text // JSON array

  // ‚úÖ INFORMACI√ìN M√âDICA PARA COMPLIANCE LEGAL
  hasAllergies         Boolean? @map("has_allergies")
  allergyDetails       String?  @map("allergy_details") @db.Text // JSON
  hasMedicalConditions Boolean? @map("has_medical_conditions")
  medicalDetails       String?  @map("medical_details") @db.Text // JSON
  takingMedications    Boolean? @map("taking_medications")
  medicationDetails    String?  @map("medication_details") @db.Text // JSON
  emergencyContact     String?  @map("emergency_contact") @db.Text // JSON
  
  // ‚úÖ CONSENTIMIENTOS Y GDPR
  generalConsentDate    DateTime? @map("general_consent_date")
  marketingConsentDate  DateTime? @map("marketing_consent_date")
  dataProcessingConsent Boolean   @default(false) @map("data_processing_consent")
  gdprAcceptedAt        DateTime? @map("gdpr_accepted_at")

  // Informaci√≥n est√©tica y preferencias
  skinType             String? @map("skin_type") @db.VarChar(20)
  treatmentPreferences String? @map("treatment_preferences") @db.Text // JSON
  beautyGoals          String? @map("beauty_goals") @db.Text // JSON

  // ‚úÖ SISTEMA DE GAMIFICACI√ìN Y LEALTAD
  beautyPoints      Int     @default(0) @map("beauty_points")
  totalInvestment   Decimal @default(0) @map("total_investment") @db.Decimal(10,2)
  sessionsCompleted Int     @default(0) @map("sessions_completed")
  loyaltyTier       String  @default("BRONZE") @map("loyalty_tier") @db.VarChar(20)
  vipStatus         Boolean @default(false) @map("vip_status")
  vipSince          DateTime? @map("vip_since")

  // M√©tricas de engagement
  totalAppointments     Int     @default(0) @map("total_appointments")
  cancelledAppointments Int     @default(0) @map("cancelled_appointments")
  noShowCount           Int     @default(0) @map("no_show_count")
  averageRating         Decimal? @map("average_rating") @db.Decimal(3,2)

  // ‚úÖ CONFIGURACI√ìN DE NOTIFICACIONES
  pushToken              String?   @map("push_token") @db.Text
  devicePlatform         String?   @map("device_platform") @db.VarChar(20)
  deviceInfo             String?   @map("device_info") @db.Text // JSON
  pushSettings           String?   @map("push_settings") @db.Text // JSON
  emailNotifications     Boolean   @default(true) @map("email_notifications")
  smsNotifications       Boolean   @default(false) @map("sms_notifications")
  marketingNotifications Boolean   @default(true) @map("marketing_notifications")
  reminderPreference     String    @default("24h") @map("reminder_preference") @db.VarChar(10)
  lastNotificationSent   DateTime? @map("last_notification_sent")

  // Estados de seguridad
  isActive      Boolean   @default(true) @map("is_active")
  isVerified    Boolean   @default(false) @map("is_verified")
  isBlocked     Boolean   @default(false) @map("is_blocked")
  blockReason   String?   @map("block_reason") @db.Text
  lastLoginAt   DateTime? @map("last_login_at")
  loginAttempts Int       @default(0) @map("login_attempts")
  lockedUntil   DateTime? @map("locked_until")

  // Marketing y referidos
  referralCode        String? @unique @map("referral_code") @db.VarChar(20)
  referredBy          String? @map("referred_by") @db.VarChar(20)
  onboardingCompleted Boolean @default(false) @map("onboarding_completed")
  privacyAccepted     Boolean @default(false) @map("privacy_accepted")
  termsAccepted       Boolean @default(false) @map("terms_accepted")
  marketingAccepted   Boolean @default(false) @map("marketing_accepted")

  // Configuraci√≥n de localizaci√≥n
  preferredLanguage String @default("es") @map("preferred_language") @db.VarChar(5)
  preferredCurrency String @default("EUR") @map("preferred_currency") @db.VarChar(3)
  timezone          String @default("Europe/Madrid") @db.VarChar(50)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones (definidas en otros m√≥dulos)
  primaryClinic       Clinic               @relation(fields: [primaryClinicId], references: [id])
  appointments        Appointment[]
  vipSubscriptions    VipSubscription[]
  invitations         Invitation[]
  passwordResetTokens PasswordResetToken[]
  rewardRedemptions   RewardRedemption[]
  stripeCustomer      StripeCustomer?
  paymentMethods      PaymentMethod[]
  payments            Payment[]
  notificationLogs    NotificationLog[]
  offerRedemptions    OfferRedemption[]
  userSessions        UserSession[]
  patientConsents     PatientConsent[]
  consentHistory      ConsentHistory[]
  appointmentReviews  AppointmentReview[] @relation("UserAppointmentReviews")

  @@index([primaryClinicId, isActive], map: "idx_user_clinic")
  @@index([email], map: "idx_user_email")
  @@index([loyaltyTier, vipStatus], map: "idx_user_loyalty")
  @@index([referralCode], map: "idx_user_referral")
  @@index([role, isActive], map: "idx_user_role")
  @@index([beautyPoints], map: "idx_user_points")
  @@map("users")
}

// ============================================================================
// üë®‚Äç‚öïÔ∏è MODELO PROFESSIONAL - ESPECIALISTA CON AUTENTICACI√ìN COMPLETA
// ============================================================================

/// Profesional que realiza tratamientos est√©ticos
/// Incluye autenticaci√≥n independiente y m√©tricas de performance
model Professional {
  /// Identificador √∫nico del profesional
  id       String @id @default(cuid())
  clinicId String @map("clinic_id")

  // Autenticaci√≥n independiente
  email        String   @unique @db.VarChar(100)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  role         UserRole @default(PROFESSIONAL)

  // Datos personales
  firstName String    @map("first_name") @db.VarChar(50)
  lastName  String    @map("last_name") @db.VarChar(50)
  phone     String?   @db.VarChar(20)
  avatarUrl String?   @map("avatar_url") @db.Text
  birthDate DateTime? @map("birth_date") @db.Date

  // Datos profesionales y certificaciones
  licenseNumber  String? @map("license_number") @db.VarChar(50)
  specialties    String  @db.Text // JSON array de especialidades
  certifications String? @db.Text // JSON array de certificaciones
  experience     Int?    // A√±os de experiencia
  bio            String? @db.Text
  languages      String? @db.Text // JSON array de idiomas
  education      String? @db.Text // JSON formaci√≥n acad√©mica

  // Configuraci√≥n laboral
  employmentType String  @default("FULL_TIME") @map("employment_type") @db.VarChar(20)
  hourlyRate     Decimal? @map("hourly_rate") @db.Decimal(8,2)
  commissionRate Decimal? @map("commission_rate") @db.Decimal(5,2)
  availableHours String? @map("available_hours") @db.Text // JSON
  workingDays    String? @map("working_days") @db.Text // JSON

  // ‚úÖ M√âTRICAS DE PERFORMANCE PROFESIONAL
  rating              Decimal @default(5.0) @db.Decimal(3,2)
  totalAppointments   Int     @default(0) @map("total_appointments")
  totalRevenue        Decimal @default(0) @map("total_revenue") @db.Decimal(10,2)
  patientSatisfaction Decimal @default(5.0) @map("patient_satisfaction") @db.Decimal(3,2)
  onTimePercentage    Decimal @default(100) @map("on_time_percentage") @db.Decimal(5,2)
  cancellationRate    Decimal @default(0) @map("cancellation_rate") @db.Decimal(5,2)

  // Sistema de permisos granular
  permissions         String  @default("[]") @db.Text // JSON array
  canManageSchedule   Boolean @default(true) @map("can_manage_schedule")
  canViewReports      Boolean @default(false) @map("can_view_reports")
  canManagePatients   Boolean @default(false) @map("can_manage_patients")
  canManageTreatments Boolean @default(false) @map("can_manage_treatments")
  canProcessPayments  Boolean @default(false) @map("can_process_payments")

  // Estados de activaci√≥n y verificaci√≥n
  isActive            Boolean   @default(true) @map("is_active")
  isVerified          Boolean   @default(false) @map("is_verified")
  onboardingCompleted Boolean   @default(false) @map("onboarding_completed")
  lastLoginAt         DateTime? @map("last_login_at")
  emailVerified       Boolean   @default(false) @map("email_verified")

  // Configuraci√≥n personal
  notificationSettings String? @map("notification_settings") @db.Text // JSON
  workPreferences      String? @map("work_preferences") @db.Text // JSON

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones (definidas en otros m√≥dulos)
  clinic              Clinic                      @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  appointments        Appointment[]
  passwordResetTokens ProfessionalPasswordReset[]
  userSessions        UserSession[]
  appointmentReviews  AppointmentReview[] @relation("ProfessionalAppointmentReviews")

  @@index([clinicId, isActive], map: "idx_professional_clinic")
  @@index([email], map: "idx_professional_email")
  @@index([role, clinicId], map: "idx_professional_role")
  @@index([rating, totalAppointments], map: "idx_professional_performance")
  @@map("professionals")
}

// ============================================================================
// üîë MODELO USER SESSIONS - GESTI√ìN DE SESIONES SEGURAS
// ============================================================================

/// Gesti√≥n de sesiones para usuarios y profesionales
/// Incluye tracking de dispositivos y seguridad avanzada
model UserSession {
  /// Identificador √∫nico de la sesi√≥n
  id             String  @id @default(cuid())
  userId         String? @map("user_id")
  professionalId String? @map("professional_id")
  sessionType    String  @map("session_type") @db.VarChar(20) // USER, PROFESSIONAL

  // Tokens de autenticaci√≥n
  token        String   @unique @db.VarChar(255)
  refreshToken String?  @map("refresh_token") @db.VarChar(255)
  expiresAt    DateTime @map("expires_at")

  // Informaci√≥n del dispositivo para seguridad
  deviceId   String? @map("device_id") @db.VarChar(100)
  deviceType String? @map("device_type") @db.VarChar(20)
  deviceName String? @map("device_name") @db.VarChar(100)
  platform   String? @db.VarChar(20) // ios, android, web
  appVersion String? @map("app_version") @db.VarChar(20)

  // Informaci√≥n de red y geolocalizaci√≥n
  ipAddress String? @map("ip_address") @db.VarChar(45)
  userAgent String? @map("user_agent") @db.Text
  location  String? @db.Text // JSON con geolocalizaci√≥n
  country   String? @db.VarChar(2)
  city      String? @db.VarChar(50)

  // Estados de la sesi√≥n
  isActive  Boolean @default(true) @map("is_active")
  isRevoked Boolean @default(false) @map("is_revoked")

  // Actividad y revocaci√≥n
  lastActivity  DateTime  @default(now()) @map("last_activity")
  revokedAt     DateTime? @map("revoked_at")
  revokedReason String?   @map("revoked_reason") @db.Text

  // Configuraci√≥n de seguridad
  loginMethod         String  @default("PASSWORD") @map("login_method") @db.VarChar(20)
  twoFactorEnabled    Boolean @default(false) @map("two_factor_enabled")
  suspiciousActivity  Boolean @default(false) @map("suspicious_activity")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  professional Professional? @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@index([token], map: "idx_session_token")
  @@index([userId, isActive], map: "idx_user_sessions")
  @@index([professionalId, isActive], map: "idx_professional_sessions")
  @@index([expiresAt], map: "idx_session_expiry")
  @@index([ipAddress], map: "idx_session_ip")
  @@map("user_sessions")
}

// ============================================================================
// üîì TOKENS DE RESET PARA USUARIOS
// ============================================================================

/// Tokens de recuperaci√≥n de contrase√±a para usuarios
/// Incluye metadata de seguridad y tracking de uso
model PasswordResetToken {
  /// Identificador √∫nico del token
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  
  // Token y expiraci√≥n
  token     String   @unique @db.VarChar(255)
  expiresAt DateTime @map("expires_at")
  
  // Control de uso
  used      Boolean   @default(false)
  usedAt    DateTime? @map("used_at")
  
  // Metadata de seguridad
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  userAgent String?  @map("user_agent") @db.Text
  
  // Timestamp
  createdAt DateTime @default(now()) @map("created_at")

  // Relaciones
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token], map: "idx_reset_token")
  @@index([expiresAt], map: "idx_reset_expiry")
  @@map("password_reset_tokens")
}

// ============================================================================
// üîì TOKENS DE RESET PARA PROFESIONALES
// ============================================================================

/// Tokens de recuperaci√≥n de contrase√±a para profesionales
/// Sistema independiente para mayor seguridad
model ProfessionalPasswordReset {
  /// Identificador √∫nico del token
  id             String   @id @default(cuid())
  professionalId String   @map("professional_id")
  
  // Token y expiraci√≥n
  token          String   @unique @db.VarChar(255)
  expiresAt      DateTime @map("expires_at")
  
  // Control de uso
  used           Boolean   @default(false)
  usedAt         DateTime? @map("used_at")
  
  // Metadata de seguridad
  ipAddress      String?  @map("ip_address") @db.VarChar(45)
  userAgent      String?  @map("user_agent") @db.Text
  
  // Timestamp
  createdAt      DateTime @default(now()) @map("created_at")

  // Relaciones
  professional Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@index([token], map: "idx_prof_reset_token")
  @@index([expiresAt], map: "idx_prof_reset_expiry")
  @@map("professional_password_resets")
}

// ============================================================================
// üîö FIN DEL M√ìDULO DE AUTENTICACI√ìN
// ============================================================================
// Total de modelos: 5
// L√≠neas: ~280
// Funcionalidad: Autenticaci√≥n completa, sesiones y recuperaci√≥n de contrase√±as
// ============================================================================

// ============================================================================
// üìÅ M√ìDULO 3: 03-CLINIC
// ============================================================================

// ============================================================================
// üè• DOMINIO: CL√çNICAS - ESTABLECIMIENTOS Y CONFIGURACI√ìN REGIONAL
// ============================================================================
// Modelos incluidos: Clinic, RegionalConfig
// Dependencias: 01-base.prisma (enums), 02-auth.prisma (User, Professional)
// √öltima actualizaci√≥n: 2025-08-20
// ============================================================================

// ============================================================================
// üè¢ MODELO CLINIC - ESTABLECIMIENTO CON COMPLIANCE LEGAL COMPLETO
// ============================================================================

/// Cl√≠nica de est√©tica con configuraci√≥n legal y de negocio completa
/// Incluye compliance para diferentes comunidades aut√≥nomas espa√±olas
model Clinic {
  /// Identificador √∫nico de la cl√≠nica
  id           String  @id @default(cuid())
  
  // Informaci√≥n b√°sica de la cl√≠nica
  name         String  @db.VarChar(100)
  slug         String  @unique @db.VarChar(50)
  email        String  @unique @db.VarChar(100)
  passwordHash String  @map("password_hash") @db.VarChar(255)
  phone        String  @db.VarChar(20)
  
  // Direcci√≥n y localizaci√≥n
  address      String  @db.Text
  city         String  @db.VarChar(50)
  postalCode   String? @map("postal_code") @db.VarChar(10)
  country      String  @default("ES") @db.VarChar(2)
  timezone     String  @default("Europe/Madrid") @db.VarChar(50)
  
  // Branding y presencia digital
  logoUrl      String? @map("logo_url") @db.Text
  websiteUrl   String? @map("website_url") @db.Text
  brandColors  String? @map("brand_colors") @db.Text // JSON con colores corporativos

  // ‚úÖ INFORMACI√ìN LEGAL Y SANITARIA OBLIGATORIA
  medicalLicense       String?  @map("medical_license") @db.VarChar(50)
  healthRegistration   String?  @map("health_registration") @db.VarChar(50)
  autonomousCommunity  String?  @map("autonomous_community") @db.VarChar(50)
  taxId                String?  @map("tax_id") @db.VarChar(20) // CIF
  legalCompliance      String?  @map("legal_compliance") @db.Text // JSON
  
  // ‚úÖ CONFIGURACI√ìN DE CONSENTIMIENTOS
  defaultConsentPolicy     String?  @map("default_consent_policy") @db.Text // JSON
  requiresDigitalSignature Boolean  @default(false) @map("requires_digital_signature")
  
  // ‚úÖ CONFIGURACI√ìN DE TRATAMIENTOS Y RIESGOS
  allowsDirectBookingHighRisk Boolean @default(false) @map("allows_direct_booking_high_risk")
  consultationMinimumTime     Int?    @map("consultation_minimum_time") // minutos
  maxAdvanceBookingDays       Int     @default(90) @map("max_advance_booking_days")

  // Configuraci√≥n de horarios de negocio
  businessHours         String    @map("business_hours") @db.Text // JSON con horarios

  // Plan de suscripci√≥n y l√≠mites
  subscriptionPlan      String    @default("FREE") @map("subscription_plan") @db.VarChar(20)
  subscriptionExpiresAt DateTime? @map("subscription_expires_at")
  maxProfessionals      Int       @default(2) @map("max_professionals")
  maxPatients           Int       @default(100) @map("max_patients")

  // ‚úÖ FEATURES HABILITADAS POR PLAN
  enableVipProgram      Boolean @default(true) @map("enable_vip_program")
  enableNotifications   Boolean @default(true) @map("enable_notifications")
  enableOnlineBooking   Boolean @default(true) @map("enable_online_booking")
  enablePayments        Boolean @default(false) @map("enable_payments")
  enableLoyaltyProgram  Boolean @default(true) @map("enable_loyalty_program")

  // Estados de activaci√≥n y verificaci√≥n
  isActive            Boolean @default(true) @map("is_active")
  isVerified          Boolean @default(false) @map("is_verified")
  onboardingCompleted Boolean @default(false) @map("onboarding_completed")
  emailVerified       Boolean @default(false) @map("email_verified")

  // Configuraci√≥n adicional y metadata
  settings  String? @db.Text // JSON configuraciones adicionales
  metadata  String? @db.Text // JSON metadata adicional

  // Timestamps de seguimiento
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  lastLoginAt DateTime? @map("last_login_at")

  // Relaciones con otros m√≥dulos
  professionals        Professional[]
  users               User[]
  treatments          Treatment[]
  appointments        Appointment[]
  rewardTemplates     RewardTemplate[]
  offers              Offer[]
  consentFormTemplates ConsentFormTemplate[]
  wellnessTips        WellnessTip[]
  regionalConfig      RegionalConfig?

  @@index([slug], map: "idx_clinic_slug")
  @@index([city, isActive], map: "idx_clinic_location")
  @@index([subscriptionPlan, subscriptionExpiresAt], map: "idx_clinic_subscription")
  @@index([isActive, isVerified], map: "idx_clinic_status")
  @@index([autonomousCommunity], map: "idx_clinic_autonomous_community")
  @@map("clinics")
}

// ============================================================================
// üåç MODELO REGIONAL CONFIG - CONFIGURACI√ìN POR COMUNIDAD AUT√ìNOMA
// ============================================================================

/// Configuraci√≥n espec√≠fica por comunidad aut√≥noma espa√±ola
/// Permite adaptar el sistema a las regulaciones locales de cada regi√≥n
model RegionalConfig {
  /// Identificador √∫nico de la configuraci√≥n
  id                   String @id @default(cuid())
  clinicId             String @unique @map("clinic_id")
  autonomousCommunity  String @map("autonomous_community") @db.VarChar(50)
  
  // ‚úÖ CONFIGURACIONES ESPEC√çFICAS POR REGI√ìN
  requiresMedicalLicense      Boolean @default(false) @map("requires_medical_license")
  highRiskRequiresDoctor      Boolean @default(true) @map("high_risk_requires_doctor")
  mandatoryConsentTypes       String  @default("[]") @map("mandatory_consent_types") @db.Text // JSON
  minimumConsultationTime     Int?    @map("minimum_consultation_time")
  
  // ‚úÖ REGULACIONES ESPEC√çFICAS DE TRATAMIENTOS
  allowedTreatmentTypes       String  @default("[]") @map("allowed_treatment_types") @db.Text // JSON
  restrictedTreatmentTypes    String  @default("[]") @map("restricted_treatment_types") @db.Text // JSON
  
  // ‚úÖ DOCUMENTACI√ìN REQUERIDA POR LEY
  requiredDocumentation       String  @default("[]") @map("required_documentation") @db.Text // JSON
  specialRequirements         String? @map("special_requirements") @db.Text
  
  // ‚úÖ CONFIGURACI√ìN DE HORARIOS OBLIGATORIOS
  restrictedHours             String? @map("restricted_hours") @db.Text // JSON
  mandatoryBreaks             String? @map("mandatory_breaks") @db.Text // JSON
  
  // ‚úÖ CONFIGURACIONES ADICIONALES ESPEC√çFICAS
  maxTreatmentDuration        Int?    @map("max_treatment_duration") // minutos
  mandatoryWaitingTime        Int?    @map("mandatory_waiting_time") // minutos entre tratamientos
  requiresParentalConsent     Boolean @default(false) @map("requires_parental_consent")
  minimumAgeForTreatments     Int?    @map("minimum_age_for_treatments")
  
  // ‚úÖ COMPLIANCE ESPEC√çFICO POR REGI√ìN
  dataRetentionPeriod         Int?    @map("data_retention_period") // d√≠as
  mandatoryReportingPeriod    Int?    @map("mandatory_reporting_period") // d√≠as
  requiresHealthInspection    Boolean @default(false) @map("requires_health_inspection")
  inspectionFrequency         Int?    @map("inspection_frequency") // meses
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relaci√≥n con cl√≠nica
  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  
  @@index([autonomousCommunity], map: "idx_regional_config_community")
  @@index([clinicId], map: "idx_regional_config_clinic")
  @@map("regional_configs")
}

// ============================================================================
// üìä √çNDICES ESTRAT√âGICOS PARA PERFORMANCE
// ============================================================================
// √çndices espec√≠ficos para queries frecuentes de cl√≠nicas:
//
// 1. B√∫squeda por ubicaci√≥n y estado:
//    - idx_clinic_location: Para b√∫squedas geogr√°ficas activas
//
// 2. Gesti√≥n de suscripciones:
//    - idx_clinic_subscription: Para control de vencimientos
//
// 3. Estados operativos:
//    - idx_clinic_status: Para filtros de cl√≠nicas activas/verificadas
//
// 4. Compliance regional:
//    - idx_clinic_autonomous_community: Para agrupaci√≥n por regi√≥n
//    - idx_regional_config_community: Para configuraciones espec√≠ficas
//
// ============================================================================

// ============================================================================
// üîö FIN DEL M√ìDULO DE CL√çNICAS
// ============================================================================
// Total de modelos: 2
// L√≠neas: ~165
// Funcionalidad: Gesti√≥n de cl√≠nicas y configuraci√≥n regional completa
// ============================================================================

// ============================================================================
// üìÅ M√ìDULO 4: 04-MEDICAL
// ============================================================================

// ============================================================================
// üíâ DOMINIO: M√âDICO - TRATAMIENTOS Y COMPLIANCE LEGAL
// ============================================================================
// Modelos incluidos: Treatment, ConsentFormTemplate, PatientConsent, ConsentHistory
// Dependencias: 01-base.prisma (enums), 02-auth.prisma (User), 03-clinic.prisma (Clinic)
// √öltima actualizaci√≥n: 2025-08-20
// ============================================================================

// ============================================================================
// üíä MODELO TREATMENT - TRATAMIENTO CON COMPLIANCE LEGAL COMPLETO
// ============================================================================

/// Tratamiento est√©tico con clasificaci√≥n legal y configuraci√≥n de riesgos
/// Incluye toda la informaci√≥n necesaria para compliance sanitario
model Treatment {
  /// Identificador √∫nico del tratamiento
  id       String @id @default(cuid())
  clinicId String @map("clinic_id")

  // Informaci√≥n b√°sica del tratamiento
  name             String @db.VarChar(100)
  description      String @db.Text
  shortDescription String? @map("short_description") @db.VarChar(200)
  category         String @db.VarChar(50)
  subcategory      String? @db.VarChar(50)

  // ‚úÖ CLASIFICACI√ìN LEGAL SEG√öN NORMATIVA ESPA√ëOLA
  riskLevel                TreatmentRiskLevel @default(LOW) @map("risk_level")
  requiresConsultation     Boolean            @default(false) @map("requires_consultation")
  requiresMedicalStaff     Boolean            @default(false) @map("requires_medical_staff")
  consentType              ConsentType        @default(SIMPLE) @map("consent_type")
  regulatoryCategory       String?            @map("regulatory_category") @db.VarChar(50)
  
  // ‚úÖ INFORMACI√ìN M√âDICA LEGAL OBLIGATORIA
  minimumAge               Int?               @map("minimum_age")
  maximumAge               Int?               @map("maximum_age")
  contraindications        String?            @db.Text // JSON array de contraindicaciones
  sideEffects              String?            @map("side_effects") @db.Text // JSON array
  recoveryTime             String?            @map("recovery_time") @db.VarChar(50)
  followUpRequired         Boolean            @default(false) @map("follow_up_required")
  followUpDays             Int?               @map("follow_up_days")
  
  // ‚úÖ CONSENTIMIENTO INFORMADO CONFIGURACI√ìN
  consentFormRequired      Boolean            @default(false) @map("consent_form_required")
  consentFormTemplateId    String?            @map("consent_form_template_id")
  digitalSignatureRequired Boolean            @default(false) @map("digital_signature_required")
  
  // ‚úÖ CONFIGURACI√ìN DE RESERVA SEG√öN RIESGO
  appointmentType          AppointmentType    @default(DIRECT) @map("appointment_type")
  consultationDuration     Int?               @map("consultation_duration")
  allowSameDayConsultation Boolean            @default(true) @map("allow_same_day_consultation")
  
  // ‚úÖ PROFESIONALES AUTORIZADOS
  authorizedProfessionalTypes String?         @map("authorized_professional_types") @db.Text // JSON
  requiresSpecialization   Boolean            @default(false) @map("requires_specialization")
  requiredCertifications   String?            @map("required_certifications") @db.Text // JSON

  // Configuraci√≥n de duraci√≥n y precios
  durationMinutes Int     @map("duration_minutes")
  price           Decimal @db.Decimal(8,2)
  vipPrice        Decimal? @map("vip_price") @db.Decimal(8,2)
  preparationTime Int     @default(0) @map("preparation_time")
  cleanupTime     Int     @default(0) @map("cleanup_time")

  // Configuraci√≥n visual y marketing
  iconName String  @map("icon_name") @db.VarChar(50)
  color    String? @db.VarChar(7) // Hex color
  imageUrl String? @map("image_url") @db.Text
  gallery  String? @db.Text // JSON array de URLs

  // Configuraci√≥n de negocio
  isVipExclusive       Boolean @default(false) @map("is_vip_exclusive")
  maxSessionsPerMonth  Int?    @map("max_sessions_per_month")
  beautyPointsEarned   Int     @default(10) @map("beauty_points_earned")
  commissionRate       Decimal? @map("commission_rate") @db.Decimal(5,2)

  // Estados operativos
  isActive   Boolean @default(true) @map("is_active")
  isFeatured Boolean @default(false) @map("is_featured")
  isPopular  Boolean @default(false) @map("is_popular")
  isNew      Boolean @default(false) @map("is_new")
  isArchived Boolean @default(false) @map("is_archived")

  // SEO y marketing
  tags           String? @db.Text // JSON array
  seoTitle       String? @map("seo_title") @db.VarChar(200)
  seoDescription String? @map("seo_description") @db.Text
  sortOrder      Int     @default(0) @map("sort_order")

  // Analytics de performance
  totalBookings  Int @default(0) @map("total_bookings")
  avgRating      Decimal? @map("avg_rating") @db.Decimal(3,2)
  viewCount      Int @default(0) @map("view_count")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  clinic               Clinic               @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  appointments         Appointment[]
  consentFormTemplate  ConsentFormTemplate? @relation(fields: [consentFormTemplateId], references: [id])
  patientConsents      PatientConsent[]
  appointmentReviews   AppointmentReview[] @relation("TreatmentAppointmentReviews")

  @@index([clinicId, isActive], map: "idx_treatment_clinic")
  @@index([category, isActive], map: "idx_treatment_category")
  @@index([riskLevel, requiresConsultation], map: "idx_treatment_legal")
  @@index([isVipExclusive, isFeatured], map: "idx_treatment_special")
  @@index([price, isActive], map: "idx_treatment_price")
  @@index([appointmentType], map: "idx_treatment_appointment_type")
  @@map("treatments")
}

// ============================================================================
// üìã MODELO CONSENT FORM TEMPLATE - PLANTILLAS DE CONSENTIMIENTO
// ============================================================================

/// Plantilla de formulario de consentimiento para compliance legal
/// Versionado y configurable por tipo de tratamiento
model ConsentFormTemplate {
  /// Identificador √∫nico de la plantilla
  id       String @id @default(cuid())
  clinicId String @map("clinic_id")

  // Informaci√≥n b√°sica de la plantilla
  name        String @db.VarChar(100)
  description String? @db.Text
  version     String @default("1.0") @db.VarChar(10)
  language    String @default("es") @db.VarChar(5)

  // Contenido del formulario legal
  title       String @db.VarChar(200)
  content     String @db.Text // HTML del formulario
  fields      String @db.Text // JSON con campos requeridos
  
  // Configuraci√≥n legal espec√≠fica
  isActive    Boolean @default(true) @map("is_active")
  isMandatory Boolean @default(false) @map("is_mandatory")
  
  // Tipo de consentimiento seg√∫n normativa
  consentType ConsentType @map("consent_type")
  
  // Per√≠odo de validez legal
  validFrom   DateTime @map("valid_from")
  validUntil  DateTime? @map("valid_until")

  // Configuraci√≥n adicional de compliance
  requiresWitness       Boolean @default(false) @map("requires_witness")
  requiresParentConsent Boolean @default(false) @map("requires_parent_consent")
  minimumAge            Int?    @map("minimum_age")
  
  // Configuraci√≥n de almacenamiento GDPR
  dataRetentionPeriod   Int?    @map("data_retention_period") // d√≠as
  allowsDataProcessing  Boolean @default(true) @map("allows_data_processing")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  clinic      Clinic          @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  treatments  Treatment[]
  consents    PatientConsent[]

  @@index([clinicId, isActive], map: "idx_consent_template_clinic")
  @@index([consentType], map: "idx_consent_template_type")
  @@index([validFrom, validUntil], map: "idx_consent_template_validity")
  @@index([version], map: "idx_consent_template_version")
  @@map("consent_form_templates")
}

// ============================================================================
// ‚úçÔ∏è MODELO PATIENT CONSENT - CONSENTIMIENTOS DE PACIENTES
// ============================================================================

/// Consentimiento espec√≠fico de un paciente para un tratamiento
/// Incluye firma digital y validaci√≥n m√©dica
model PatientConsent {
  /// Identificador √∫nico del consentimiento
  id          String @id @default(cuid())
  userId      String @map("user_id")
  treatmentId String? @map("treatment_id")
  templateId  String @map("template_id")
  
  // ‚úÖ INFORMACI√ìN DE CONSENTIMIENTO LEGAL
  isConsented      Boolean   @default(false) @map("is_consented")
  consentedAt      DateTime? @map("consented_at")
  digitalSignature String?   @map("digital_signature") @db.Text
  ipAddress        String?   @map("ip_address") @db.VarChar(45)
  userAgent        String?   @map("user_agent") @db.Text
  
  // ‚úÖ DATOS DEL FORMULARIO COMPLETADO
  formData         String?   @db.Text // JSON con respuestas del paciente
  
  // ‚úÖ INFORMACI√ìN M√âDICA RELEVANTE ESPEC√çFICA
  allergies        String?   @db.Text // JSON array de alergias
  medications      String?   @db.Text // JSON array de medicamentos
  medicalHistory   String?   @map("medical_history") @db.Text
  previousTreatments String? @map("previous_treatments") @db.Text // JSON
  
  // ‚úÖ VALIDACI√ìN M√âDICA PROFESIONAL
  reviewedBy       String?   @map("reviewed_by") // Professional ID
  reviewedAt       DateTime? @map("reviewed_at")
  medicalApproval  Boolean?  @map("medical_approval")
  approvalNotes    String?   @map("approval_notes") @db.Text
  
  // Estados del consentimiento
  status           String    @default("PENDING") @db.VarChar(20)
  
  // Validez temporal del consentimiento
  expiresAt        DateTime? @map("expires_at")
  
  // ‚úÖ TESTIGO (SI ES REQUERIDO POR LEY)
  witnessName      String?   @map("witness_name") @db.VarChar(100)
  witnessSignature String?   @map("witness_signature") @db.Text
  witnessId        String?   @map("witness_id") // Professional ID del testigo
  
  // ‚úÖ INFORMACI√ìN PARENTAL (MENORES DE EDAD)
  parentName       String?   @map("parent_name") @db.VarChar(100)
  parentSignature  String?   @map("parent_signature") @db.Text
  parentRelation   String?   @map("parent_relation") @db.VarChar(50)
  parentId         String?   @map("parent_id") @db.VarChar(20) // DNI/NIE

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  treatment Treatment?           @relation(fields: [treatmentId], references: [id])
  template  ConsentFormTemplate @relation(fields: [templateId], references: [id])

  @@index([userId, status], map: "idx_patient_consent_user")
  @@index([treatmentId], map: "idx_patient_consent_treatment")
  @@index([status, expiresAt], map: "idx_patient_consent_validity")
  @@index([reviewedBy], map: "idx_patient_consent_reviewer")
  @@map("patient_consents")
}

// ============================================================================
// üìú MODELO CONSENT HISTORY - HISTORIAL DE CONSENTIMIENTOS PARA AUDIT
// ============================================================================

/// Historial completo de consentimientos para trazabilidad legal
/// Registro inmutable para auditor√≠as y compliance GDPR
model ConsentHistory {
  /// Identificador √∫nico del registro hist√≥rico
  id             String   @id @default(cuid())
  userId         String   @map("user_id")
  consentType    String   @map("consent_type") @db.VarChar(50)
  version        String   @default("1.0") @db.VarChar(10)
  
  // ‚úÖ ESTADO DEL CONSENTIMIENTO EN EL MOMENTO
  isConsented    Boolean  @map("is_consented")
  consentedAt    DateTime @map("consented_at")
  revokedAt      DateTime? @map("revoked_at")
  
  // ‚úÖ METADATA DE TRAZABILIDAD LEGAL
  ipAddress      String?  @map("ip_address") @db.VarChar(45)
  userAgent      String?  @map("user_agent") @db.Text
  method         String   @default("DIGITAL") @db.VarChar(20) // DIGITAL, PAPER, VERBAL
  
  // ‚úÖ EVIDENCIA LEGAL
  digitalSignature String? @map("digital_signature") @db.Text
  witnessId        String? @map("witness_id")
  notes            String? @db.Text
  
  // ‚úÖ CONTEXTO LEGAL ADICIONAL
  legalBasis       String? @map("legal_basis") @db.VarChar(100) // Base legal GDPR
  processingPurpose String? @map("processing_purpose") @db.Text
  dataCategories   String? @map("data_categories") @db.Text // JSON
  
  // Timestamp inmutable
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relaci√≥n
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, consentType], map: "idx_consent_history_user")
  @@index([consentedAt], map: "idx_consent_history_date")
  @@index([legalBasis], map: "idx_consent_history_legal")
  @@map("consent_history")
}

// ============================================================================
// üìä √çNDICES ESTRAT√âGICOS PARA COMPLIANCE Y PERFORMANCE
// ============================================================================
// √çndices espec√≠ficos para queries de compliance m√©dico:
//
// 1. B√∫squedas por riesgo legal:
//    - idx_treatment_legal: Para filtrar por nivel de riesgo y consulta
//
// 2. Gesti√≥n de consentimientos:
//    - idx_consent_template_validity: Para plantillas vigentes
//    - idx_patient_consent_validity: Para consentimientos v√°lidos
//
// 3. Auditor√≠a y trazabilidad:
//    - idx_consent_history_date: Para reportes temporales
//    - idx_consent_history_legal: Para compliance GDPR
//
// 4. Configuraci√≥n por tipo de tratamiento:
//    - idx_treatment_appointment_type: Para flujos de reserva
//
// ============================================================================

// ============================================================================
// üîö FIN DEL M√ìDULO M√âDICO
// ============================================================================
// Total de modelos: 4
// L√≠neas: ~290
// Funcionalidad: Tratamientos con compliance legal completo y consentimientos
// ============================================================================

// ============================================================================
// üìÅ M√ìDULO 5: 05-BOOKING
// ============================================================================

// ============================================================================
// üìÖ DOMINIO: BOOKING - SISTEMA DE CITAS Y PROGRAMACI√ìN
// ============================================================================
// Modelos incluidos: Appointment
// Dependencias: Todos los m√≥dulos anteriores (User, Professional, Clinic, Treatment)
// √öltima actualizaci√≥n: 2025-08-20
// ============================================================================

// ============================================================================
// üìã MODELO APPOINTMENT - CITA CON COMPLIANCE LEGAL COMPLETO
// ============================================================================

/// Cita m√©dica/est√©tica con validaci√≥n legal y seguimiento completo
/// Incluye todo el flujo desde reserva hasta completion con compliance
model Appointment {
  /// Identificador √∫nico de la cita
  id String @id @default(cuid())

  // ‚úÖ REFERENCIAS PRINCIPALES OBLIGATORIAS
  userId         String @map("user_id")
  clinicId       String @map("clinic_id")
  professionalId String @map("professional_id")
  treatmentId    String @map("treatment_id")

  // ‚úÖ INFORMACI√ìN LEGAL Y COMPLIANCE MEJORADA
  appointmentType      AppointmentType @default(DIRECT) @map("appointment_type")
  isConsultationOnly   Boolean         @default(false) @map("is_consultation_only")
  consultationRequired Boolean         @default(false) @map("consultation_required")
  consentStatus        String?         @map("consent_status") @db.VarChar(20)
  consentFormId        String?         @map("consent_form_id")
  
  // ‚úÖ VALIDACI√ìN M√âDICA PROFESIONAL
  medicalClearance     Boolean?        @map("medical_clearance")
  clearanceProvidedBy  String?         @map("clearance_provided_by") // Professional ID
  clearanceNotes       String?         @map("clearance_notes") @db.Text
  clearanceDate        DateTime?       @map("clearance_date")
  
  // ‚úÖ CONTRAINDICACIONES Y VALIDACIONES
  contraindicationsChecked Boolean?    @map("contraindications_checked")
  allergiesVerified        Boolean?    @map("allergies_verified")
  medicationsReviewed      Boolean?    @map("medications_reviewed")
  riskAssessmentCompleted  Boolean?    @map("risk_assessment_completed")

  // ‚úÖ PROGRAMACI√ìN DETALLADA CON TIMEZONE
  scheduledDate DateTime @map("scheduled_date") @db.Date
  scheduledTime DateTime @map("scheduled_time")
  endTime       DateTime @map("end_time")
  timezone      String   @default("Europe/Madrid") @db.VarChar(50)
  
  // ‚úÖ TIEMPOS DE BUFFER Y PREPARACI√ìN
  arrivalTime     DateTime? @map("arrival_time")
  checkinTime     DateTime? @map("checkin_time")
  preparationTime Int       @default(0) @map("preparation_time")
  cleanupTime     Int       @default(0) @map("cleanup_time")
  
  // Configuraci√≥n b√°sica de la cita
  durationMinutes Int               @map("duration_minutes")
  status          AppointmentStatus @default(PENDING)
  priority        String            @default("NORMAL") @db.VarChar(10) // NORMAL, HIGH, URGENT

  // ‚úÖ NOTAS Y COMUNICACI√ìN ESTRUCTURADA
  notes             String? @db.Text
  professionalNotes String? @map("professional_notes") @db.Text
  internalNotes     String? @map("internal_notes") @db.Text
  cancelReason      String? @map("cancel_reason") @db.Text
  rescheduleReason  String? @map("reschedule_reason") @db.Text
  
  // ‚úÖ INFORMACI√ìN M√âDICA DE LA CITA
  patientCondition  String? @map("patient_condition") @db.Text
  treatmentNotes    String? @map("treatment_notes") @db.Text
  procedureDetails  String? @map("procedure_details") @db.Text
  postTreatmentCare String? @map("post_treatment_care") @db.Text
  
  // ‚úÖ FACTURACI√ìN Y PUNTOS DETALLADOS
  originalPrice      Decimal @map("original_price") @db.Decimal(8,2)
  finalPrice         Decimal @map("final_price") @db.Decimal(8,2)
  discountApplied    Decimal @default(0) @map("discount_applied") @db.Decimal(8,2)
  taxAmount          Decimal @default(0) @map("tax_amount") @db.Decimal(8,2)
  beautyPointsEarned Int     @default(0) @map("beauty_points_earned")
  beautyPointsUsed   Int     @default(0) @map("beauty_points_used")
  
  // ‚úÖ DESCUENTOS Y OFERTAS APLICADAS
  offersApplied      String? @map("offers_applied") @db.Text // JSON array de ofertas
  promoCode          String? @map("promo_code") @db.VarChar(20)
  vipDiscountApplied Boolean @default(false) @map("vip_discount_applied")
  loyaltyDiscountApplied Boolean @default(false) @map("loyalty_discount_applied")

  // ‚úÖ RECORDATORIOS Y NOTIFICACIONES AUTOM√ÅTICAS
  reminderSent     Boolean @default(false) @map("reminder_sent")
  confirmationSent Boolean @default(false) @map("confirmation_sent")
  followUpSent     Boolean @default(false) @map("follow_up_sent")
  reviewRequested  Boolean @default(false) @map("review_requested")
  
  // ‚úÖ CONFIGURACI√ìN DE RECORDATORIOS
  reminderScheduled   DateTime? @map("reminder_scheduled")
  followUpScheduled   DateTime? @map("follow_up_scheduled")
  nextAppointmentSuggested DateTime? @map("next_appointment_suggested")

  // ‚úÖ METADATA DEL BOOKING Y TRACKING
  bookingSource    String  @default("APP") @map("booking_source") @db.VarChar(20)
  isFirstVisit     Boolean @default(false) @map("is_first_visit")
  isRescheduled    Boolean @default(false) @map("is_rescheduled")
  rescheduleCount  Int     @default(0) @map("reschedule_count")
  
  // ‚úÖ INFORMACI√ìN DE PAGO DETALLADA
  paymentStatus    PaymentStatus? @map("payment_status")
  paymentMethod    String?        @map("payment_method") @db.VarChar(20)
  paymentId        String?        @map("payment_id")
  refundAmount     Decimal?       @map("refund_amount") @db.Decimal(8,2)
  refundReason     String?        @map("refund_reason") @db.Text
  
  // ‚úÖ SATISFACCI√ìN Y CALIDAD
  satisfactionScore     Int?      @map("satisfaction_score") // 1-5
  qualityControlPassed  Boolean?  @map("quality_control_passed")
  qualityNotes          String?   @map("quality_notes") @db.Text
  
  // ‚úÖ SEGUIMIENTO POST-TRATAMIENTO
  followUpRequired      Boolean   @default(false) @map("follow_up_required")
  followUpDate          DateTime? @map("follow_up_date")
  recoveryPeriodDays    Int?      @map("recovery_period_days")
  specialInstructions   String?   @map("special_instructions") @db.Text

  // ‚úÖ TIMESTAMPS DETALLADOS PARA AUDITOR√çA
  confirmedAt   DateTime? @map("confirmed_at")
  startedAt     DateTime? @map("started_at")
  completedAt   DateTime? @map("completed_at")
  cancelledAt   DateTime? @map("cancelled_at")
  noShowAt      DateTime? @map("no_show_at")
  rescheduledAt DateTime? @map("rescheduled_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // ‚úÖ RELACIONES CON OTROS M√ìDULOS
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  clinic            Clinic             @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  professional      Professional       @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  treatment         Treatment          @relation(fields: [treatmentId], references: [id], onDelete: Cascade)
  rewardRedemptions RewardRedemption[]
  offerRedemptions  OfferRedemption[]
  appointmentReview AppointmentReview?

  // ‚úÖ √çNDICES ESTRAT√âGICOS PARA PERFORMANCE Y QUERIES FRECUENTES
  @@index([userId, status], map: "idx_appointment_user_status")
  @@index([clinicId, scheduledDate], map: "idx_appointment_clinic_date")
  @@index([professionalId, scheduledDate], map: "idx_appointment_professional_schedule")
  @@index([status, scheduledDate], map: "idx_appointment_status_date")
  @@index([appointmentType, consultationRequired], map: "idx_appointment_legal_flow")
  @@index([paymentStatus], map: "idx_appointment_payment")
  @@index([bookingSource, createdAt], map: "idx_appointment_analytics")
  @@index([isFirstVisit, userId], map: "idx_appointment_first_visit")
  @@index([medicalClearance, clearanceProvidedBy], map: "idx_appointment_medical_clearance")
  @@index([followUpRequired, followUpDate], map: "idx_appointment_follow_up")
  @@map("appointments")
}

// ============================================================================
// üìä √çNDICES ESPEC√çFICOS PARA QUERIES DE NEGOCIO CR√çTICAS
// ============================================================================
// 
// 1. GESTI√ìN DIARIA DE AGENDA:
//    - idx_appointment_professional_schedule: Para cargar agenda del profesional
//    - idx_appointment_clinic_date: Para vista general de la cl√≠nica por d√≠a
//
// 2. SEGUIMIENTO DE ESTADOS LEGALES:
//    - idx_appointment_legal_flow: Para citas que requieren consulta previa
//    - idx_appointment_medical_clearance: Para validaciones m√©dicas pendientes
//
// 3. ANALYTICS Y REPORTES:
//    - idx_appointment_analytics: Para an√°lisis por canal de adquisici√≥n
//    - idx_appointment_first_visit: Para m√©tricas de nuevos clientes
//
// 4. OPERACIONES POST-TRATAMIENTO:
//    - idx_appointment_follow_up: Para seguimientos programados
//    - idx_appointment_payment: Para gesti√≥n de pagos
//
// 5. EXPERIENCIA DE USUARIO:
//    - idx_appointment_user_status: Para historial personal del cliente
//
// ============================================================================

// ============================================================================
// üîö FIN DEL M√ìDULO DE BOOKING
// ============================================================================
// Total de modelos: 1 (pero es el modelo m√°s complejo y cr√≠tico)
// L√≠neas: ~200
// Funcionalidad: Sistema completo de citas con compliance legal y seguimiento
// ============================================================================

// ============================================================================
// üìÅ M√ìDULO 6: 06-PAYMENT
// ============================================================================

// ============================================================================
// üí∞ DOMINIO: PAGOS - STRIPE INTEGRATION Y SUSCRIPCIONES
// ============================================================================
// Modelos incluidos: StripeCustomer, PaymentMethod, Payment, VipSubscription, WebhookEvent
// Dependencias: 01-base.prisma (enums), 02-auth.prisma (User)
// √öltima actualizaci√≥n: 2025-08-20
// ============================================================================

// ============================================================================
// üë§ MODELO STRIPE CUSTOMER - CLIENTE EN STRIPE
// ============================================================================

/// Cliente registrado en Stripe para procesamiento de pagos
/// Sincronizado con datos de User para consistencia
model StripeCustomer {
  /// Identificador √∫nico interno
  id               String  @id @default(cuid())
  userId           String  @unique @map("user_id")
  stripeCustomerId String  @unique @map("stripe_customer_id") @db.VarChar(100)
  
  // Informaci√≥n b√°sica sincronizada con Stripe
  email            String  @db.VarChar(100)
  name             String? @db.VarChar(100)
  phone            String? @db.VarChar(20)
  address          String? @db.Text // JSON con direcci√≥n completa
  taxId            String? @map("tax_id") @db.VarChar(20)

  // Estados del cliente en Stripe
  isDeleted Boolean   @default(false) @map("is_deleted")
  deletedAt DateTime? @map("deleted_at")

  // ‚úÖ BALANCE Y CR√âDITOS
  accountBalance Decimal @default(0) @map("account_balance") @db.Decimal(10,2)
  creditBalance  Decimal @default(0) @map("credit_balance") @db.Decimal(10,2)

  // Metadata adicional de Stripe
  metadata String? @db.Text // JSON con metadata personalizada

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaci√≥n principal
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId], map: "idx_stripe_customer_id")
  @@index([userId], map: "idx_stripe_customer_user")
  @@map("stripe_customers")
}

// ============================================================================
// üí≥ MODELO PAYMENT METHOD - M√âTODOS DE PAGO
// ============================================================================

/// M√©todo de pago almacenado en Stripe (tarjetas, SEPA, etc.)
/// Con informaci√≥n de seguridad y gesti√≥n de fraude
model PaymentMethod {
  /// Identificador √∫nico interno
  id             String @id @default(cuid())
  userId         String @map("user_id")
  stripeMethodId String @unique @map("stripe_method_id") @db.VarChar(100)

  // ‚úÖ INFORMACI√ìN DE LA TARJETA/M√âTODO
  type        String  @db.VarChar(20) // card, sepa_debit, ideal, etc.
  last4       String? @db.VarChar(4)
  brand       String? @db.VarChar(20) // visa, mastercard, amex
  expiryMonth Int?    @map("expiry_month")
  expiryYear  Int?    @map("expiry_year")
  funding     String? @db.VarChar(20) // credit, debit, prepaid
  country     String? @db.VarChar(2)

  // ‚úÖ CONFIGURACI√ìN Y PREFERENCIAS
  isDefault Boolean @default(false) @map("is_default")
  nickname  String? @db.VarChar(50) // "Tarjeta personal", "Tarjeta empresa"

  // ‚úÖ ESTADOS Y VERIFICACI√ìN
  isActive   Boolean   @default(true) @map("is_active")
  isVerified Boolean   @default(false) @map("is_verified")
  deletedAt  DateTime? @map("deleted_at")

  // ‚úÖ METADATA DE STRIPE Y SEGURIDAD
  fingerprint String? @db.VarChar(100) // Stripe fingerprint √∫nico
  metadata    String? @db.Text // JSON metadata adicional

  // ‚úÖ PREVENCI√ìN DE FRAUDE
  failedAttempts Int @default(0) @map("failed_attempts")
  lastUsedAt     DateTime? @map("last_used_at")
  
  // ‚úÖ CONFIGURACI√ìN DE 3D SECURE
  threeDSecureUsage String? @map("three_d_secure_usage") @db.VarChar(20)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaci√≥n principal
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isDefault], map: "idx_payment_method_user_default")
  @@index([userId, isActive], map: "idx_payment_method_user_active")
  @@index([stripeMethodId], map: "idx_payment_method_stripe")
  @@map("payment_methods")
}

// ============================================================================
// üí∏ MODELO PAYMENT - TRANSACCIONES DE PAGO
// ============================================================================

/// Registro completo de transacciones de pago con Stripe
/// Incluye facturaci√≥n, reembolsos y comisiones
model Payment {
  /// Identificador √∫nico de la transacci√≥n
  id       String  @id @default(cuid())
  userId   String  @map("user_id")
  clinicId String? @map("clinic_id")

  // ‚úÖ IDS DE STRIPE PARA TRAZABILIDAD
  stripeInvoiceId       String? @map("stripe_invoice_id") @db.VarChar(100)
  stripePaymentIntentId String? @map("stripe_payment_intent_id") @db.VarChar(100)
  stripeSubscriptionId  String? @map("stripe_subscription_id") @db.VarChar(100)
  stripeChargeId        String? @map("stripe_charge_id") @db.VarChar(100)

  // ‚úÖ INFORMACI√ìN B√ÅSICA DEL PAGO
  amount      Decimal @db.Decimal(10,2)
  currency    String  @default("EUR") @db.VarChar(3)
  status      PaymentStatus
  description String? @db.Text

  // ‚úÖ TIPO DE PAGO Y CONTEXTO
  paymentType String  @default("SUBSCRIPTION") @db.VarChar(20) // SUBSCRIPTION, TREATMENT, TIP
  relatedId   String? @map("related_id") // ID del appointment, subscription, etc.

  // ‚úÖ INFORMACI√ìN DE FACTURACI√ìN
  customerName  String? @map("customer_name") @db.VarChar(100)
  customerEmail String? @map("customer_email") @db.VarChar(100)
  invoiceNumber String? @map("invoice_number") @db.VarChar(50)
  taxAmount     Decimal? @map("tax_amount") @db.Decimal(8,2)
  taxRate       Decimal? @map("tax_rate") @db.Decimal(5,4) // 0.21 para 21% IVA

  // ‚úÖ M√âTODO DE PAGO UTILIZADO
  paymentMethodId   String? @map("payment_method_id")
  paymentMethodType String? @map("payment_method_type") @db.VarChar(20)
  last4Digits       String? @map("last4_digits") @db.VarChar(4)

  // ‚úÖ GESTI√ìN DE ERRORES Y REEMBOLSOS
  failureReason String? @map("failure_reason") @db.Text
  refundAmount  Decimal? @map("refund_amount") @db.Decimal(10,2)
  refundReason  String? @map("refund_reason") @db.Text

  // ‚úÖ TIMESTAMPS DETALLADOS
  paidAt     DateTime? @map("paid_at")
  refundedAt DateTime? @map("refunded_at")
  failedAt   DateTime? @map("failed_at")

  // ‚úÖ METADATA Y CONFIGURACI√ìN
  metadata   String? @db.Text // JSON metadata personalizada
  receiptUrl String? @map("receipt_url") @db.Text

  // ‚úÖ FEES Y COMISIONES
  stripeFee      Decimal? @map("stripe_fee") @db.Decimal(8,2)
  applicationFee Decimal? @map("application_fee") @db.Decimal(8,2)
  netAmount      Decimal? @map("net_amount") @db.Decimal(10,2)

  // ‚úÖ CONTEXTO DE NEGOCIO
  isRecurring Boolean @default(false) @map("is_recurring")
  isRefundable Boolean @default(true) @map("is_refundable")

  // Timestamps base
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaci√≥n principal
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status], map: "idx_payment_user_status")
  @@index([stripeInvoiceId], map: "idx_payment_stripe_invoice")
  @@index([clinicId, paymentType], map: "idx_payment_clinic_type")
  @@index([status, paidAt], map: "idx_payment_status_date")
  @@index([paymentType, status], map: "idx_payment_type_status")
  @@map("payments")
}

// ============================================================================
// üëë MODELO VIP SUBSCRIPTION - SUSCRIPCIONES PREMIUM
// ============================================================================

/// Suscripci√≥n VIP con integraci√≥n completa de Stripe
/// Incluye beneficios, tracking de uso y renovaci√≥n autom√°tica
model VipSubscription {
  /// Identificador √∫nico de la suscripci√≥n
  id       String @id @default(cuid())
  userId   String @map("user_id")
  clinicId String @map("clinic_id")

  // ‚úÖ INTEGRACI√ìN STRIPE COMPLETA
  stripeSubscriptionId String @unique @map("stripe_subscription_id") @db.VarChar(100)
  stripeCustomerId     String @map("stripe_customer_id") @db.VarChar(100)
  stripePriceId        String @map("stripe_price_id") @db.VarChar(100)

  // ‚úÖ CONFIGURACI√ìN DEL PLAN
  planType String @map("plan_type") @db.VarChar(20) // MONTHLY, QUARTERLY, YEARLY
  planName String @map("plan_name") @db.VarChar(50)
  status   String @default("ACTIVE") @db.VarChar(20) // ACTIVE, CANCELED, PAST_DUE

  // ‚úÖ PRECIOS Y MONEDA
  price    Decimal @db.Decimal(8,2)
  currency String  @default("EUR") @db.VarChar(3)
  discount Decimal @default(0) @db.Decimal(8,2)

  // ‚úÖ PER√çODOS DE FACTURACI√ìN
  currentPeriodStart DateTime  @map("current_period_start")
  currentPeriodEnd   DateTime  @map("current_period_end")
  trialStart         DateTime? @map("trial_start")
  trialEnd           DateTime? @map("trial_end")

  // ‚úÖ GESTI√ìN DE CANCELACI√ìN
  cancelAtPeriodEnd Boolean   @default(false) @map("cancel_at_period_end")
  canceledAt        DateTime? @map("canceled_at")
  cancelReason      String?   @map("cancel_reason") @db.Text
  cancelFeedback    String?   @map("cancel_feedback") @db.Text

  // ‚úÖ BENEFICIOS Y CONFIGURACI√ìN DEL PLAN
  monthlyTreatments      Int     @default(2) @map("monthly_treatments")
  usedTreatments         Int     @default(0) @map("used_treatments")
  discountPercentage     Int     @default(20) @map("discount_percentage")
  priorityBooking        Boolean @default(true) @map("priority_booking")
  freeConsultations      Boolean @default(true) @map("free_consultations")
  beautyPointsMultiplier Decimal @default(1.5) @map("beauty_points_multiplier") @db.Decimal(3,2)

  // ‚úÖ BENEFICIOS ADICIONALES PREMIUM
  personalizedRecommendations Boolean @default(true) @map("personalized_recommendations")
  exclusiveOffers            Boolean @default(true) @map("exclusive_offers")
  dedicatedSupport           Boolean @default(false) @map("dedicated_support")
  earlyAccessTreatments      Boolean @default(true) @map("early_access_treatments")

  // ‚úÖ ANALYTICS Y M√âTRICAS DE VALOR
  totalSavings       Decimal @default(0) @map("total_savings") @db.Decimal(8,2)
  treatmentsUsed     Int     @default(0) @map("treatments_used")
  totalInvestment    Decimal @default(0) @map("total_investment") @db.Decimal(10,2)
  lifetimeValue      Decimal @default(0) @map("lifetime_value") @db.Decimal(10,2)

  // ‚úÖ CONFIGURACI√ìN DE RENOVACI√ìN
  autoRenew          Boolean @default(true) @map("auto_renew")
  renewalReminded    Boolean @default(false) @map("renewal_reminded")
  renewalReminderAt  DateTime? @map("renewal_reminder_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaci√≥n principal
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status], map: "idx_vip_subscription_user_status")
  @@index([status, currentPeriodEnd], map: "idx_vip_subscription_expiry")
  @@index([stripeSubscriptionId], map: "idx_vip_subscription_stripe")
  @@index([clinicId, status], map: "idx_vip_subscription_clinic")
  @@index([planType, status], map: "idx_vip_subscription_plan")
  @@map("vip_subscriptions")
}

// ============================================================================
// üîó MODELO WEBHOOK EVENT - EVENTOS DE STRIPE
// ============================================================================

/// Eventos de webhook de Stripe para sincronizaci√≥n
/// Permite trazabilidad completa y reprocessing en caso de errores
model WebhookEvent {
  /// Identificador √∫nico del evento
  id            String @id @default(cuid())
  stripeEventId String @unique @map("stripe_event_id") @db.VarChar(100)
  eventType     String @map("event_type") @db.VarChar(50)

  // ‚úÖ ESTADO DE PROCESAMIENTO
  processed     Boolean @default(false)
  error         String? @db.Text
  retryCount    Int     @default(0) @map("retry_count")
  lastRetryAt   DateTime? @map("last_retry_at")

  // ‚úÖ DATOS COMPLETOS DEL EVENTO
  data          String  @db.Text // JSON del evento completo de Stripe
  livemode      Boolean @default(false)
  apiVersion    String? @map("api_version") @db.VarChar(20)

  // ‚úÖ METADATA DE PROCESAMIENTO
  processingStartedAt DateTime? @map("processing_started_at")
  processingCompletedAt DateTime? @map("processing_completed_at")
  processingTimeMs    Int?      @map("processing_time_ms")

  // ‚úÖ TIMESTAMPS DE STRIPE Y SISTEMA
  eventCreatedAt DateTime  @map("event_created_at")
  processedAt    DateTime? @map("processed_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  @@index([stripeEventId], map: "idx_webhook_stripe_event")
  @@index([eventType, processed], map: "idx_webhook_processing")
  @@index([createdAt], map: "idx_webhook_cleanup")
  @@index([processed, retryCount], map: "idx_webhook_retry")
  @@map("webhook_events")
}

// ============================================================================
// üìä √çNDICES ESTRAT√âGICOS PARA PERFORMANCE DE PAGOS
// ============================================================================
// 
// 1. GESTI√ìN DE CLIENTES STRIPE:
//    - idx_stripe_customer_id: B√∫squeda directa por ID de Stripe
//    - idx_payment_method_user_default: M√©todo de pago por defecto
//
// 2. PROCESAMIENTO DE PAGOS:
//    - idx_payment_status_date: Para reportes financieros por fecha
//    - idx_payment_type_status: Para an√°lisis por tipo de pago
//
// 3. SUSCRIPCIONES VIP:
//    - idx_vip_subscription_expiry: Para renovaciones autom√°ticas
//    - idx_vip_subscription_plan: Para an√°lisis por tipo de plan
//
// 4. WEBHOOKS Y SINCRONIZACI√ìN:
//    - idx_webhook_processing: Para eventos pendientes de procesar
//    - idx_webhook_retry: Para gesti√≥n de reintentos
//
// ============================================================================

// ============================================================================
// üîö FIN DEL M√ìDULO DE PAGOS
// ============================================================================
// Total de modelos: 5
// L√≠neas: ~280
// Funcionalidad: Integraci√≥n completa con Stripe y gesti√≥n de suscripciones VIP
// ============================================================================

// ============================================================================
// üìÅ M√ìDULO 7: 07-MARKETING
// ============================================================================

// ============================================================================
// üéØ DOMINIO: MARKETING - OFERTAS, GAMIFICACI√ìN Y ENGAGEMENT
// ============================================================================
// Modelos incluidos: Offer, OfferRedemption, RewardTemplate, RewardRedemption, NotificationLog, Invitation, WellnessTip
// Dependencias: 01-base.prisma (enums), 02-auth.prisma (User), 03-clinic.prisma (Clinic)
// √öltima actualizaci√≥n: 2025-08-20
// ============================================================================

// ============================================================================
// üéÅ MODELO OFFER - SISTEMA DE OFERTAS Y PROMOCIONES
// ============================================================================

/// Oferta comercial con targeting inteligente y analytics
/// Sistema completo de promociones con segmentaci√≥n avanzada
model Offer {
  /// Identificador √∫nico de la oferta
  id       String @id @default(cuid())
  clinicId String @map("clinic_id")

  // ‚úÖ INFORMACI√ìN B√ÅSICA DE LA OFERTA
  title            String @db.VarChar(100)
  description      String @db.Text
  shortDescription String? @map("short_description") @db.VarChar(200)
  terms            String? @db.Text

  // ‚úÖ CONFIGURACI√ìN DE DESCUENTO
  discountType  String  @default("PERCENTAGE") @db.VarChar(20) // PERCENTAGE, FIXED_AMOUNT, BOGO
  discountValue Decimal @db.Decimal(8,2)
  originalPrice Decimal? @map("original_price") @db.Decimal(8,2)
  finalPrice    Decimal? @map("final_price") @db.Decimal(8,2)
  minPurchase   Decimal? @map("min_purchase") @db.Decimal(8,2)

  // ‚úÖ VALIDEZ TEMPORAL
  validFrom  DateTime @map("valid_from")
  validUntil DateTime @map("valid_until")

  // ‚úÖ TARGETING Y SEGMENTACI√ìN AVANZADA
  targetAudience    String  @default("ALL") @map("target_audience") @db.VarChar(30)
  minAge            Int?    @map("min_age")
  maxAge            Int?    @map("max_age")
  genderTarget      String? @map("gender_target") @db.VarChar(20)
  loyaltyTierTarget String? @map("loyalty_tier_target") @db.VarChar(20)
  vipOnly           Boolean @default(false) @map("vip_only")
  newClientsOnly    Boolean @default(false) @map("new_clients_only")

  // ‚úÖ TRATAMIENTOS Y CATEGOR√çAS APLICABLES
  treatmentIds String @default("[]") @map("treatment_ids") @db.Text // JSON
  categoryIds  String @default("[]") @map("category_ids") @db.Text // JSON

  // ‚úÖ L√çMITES DE USO Y CONTROL
  maxUses        Int? @map("max_uses")
  maxUsesPerUser Int  @default(1) @map("max_uses_per_user")
  currentUses    Int  @default(0) @map("current_uses")

  // ‚úÖ CONFIGURACI√ìN VISUAL Y MARKETING
  imageUrl        String? @map("image_url") @db.Text
  backgroundColor String? @map("background_color") @db.VarChar(7)
  textColor       String? @map("text_color") @db.VarChar(7)
  priority        Int     @default(1)
  category        String  @default("GENERAL") @db.VarChar(20)

  // ‚úÖ CONFIGURACI√ìN DE NOTIFICACIONES
  sendNotification     Boolean @default(true) @map("send_notification")
  notificationSchedule String? @map("notification_schedule") @db.Text // JSON

  // ‚úÖ ESTADOS Y CONFIGURACI√ìN
  isActive   Boolean @default(true) @map("is_active")
  isFeatured Boolean @default(false) @map("is_featured")
  autoApply  Boolean @default(false) @map("auto_apply")

  // ‚úÖ C√ìDIGOS Y METADATA
  code String? @unique @db.VarChar(20)
  tags String? @db.Text // JSON array

  // ‚úÖ ANALYTICS DE PERFORMANCE
  viewCount       Int     @default(0) @map("view_count")
  redemptionCount Int     @default(0) @map("redemption_count")
  conversionRate  Decimal @default(0) @map("conversion_rate") @db.Decimal(5,4)
  totalRevenue    Decimal @default(0) @map("total_revenue") @db.Decimal(10,2)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  clinic           Clinic            @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  offerRedemptions OfferRedemption[]

  @@index([clinicId, isActive], map: "idx_offer_clinic_active")
  @@index([validFrom, validUntil], map: "idx_offer_validity")
  @@index([targetAudience, category], map: "idx_offer_targeting")
  @@index([code], map: "idx_offer_code")
  @@index([isFeatured, priority], map: "idx_offer_featured")
  @@map("offers")
}

// ============================================================================
// üé´ MODELO OFFER REDEMPTION - CANJES DE OFERTAS
// ============================================================================

/// Canje individual de una oferta por un usuario
/// Tracking completo del ciclo de vida del cup√≥n
model OfferRedemption {
  /// Identificador √∫nico del canje
  id            String  @id @default(cuid())
  offerId       String  @map("offer_id")
  userId        String  @map("user_id")
  appointmentId String? @map("appointment_id")

  // ‚úÖ INFORMACI√ìN DEL CANJE
  redeemedAt      DateTime @default(now()) @map("redeemed_at")
  originalPrice   Decimal  @map("original_price") @db.Decimal(8,2)
  discountApplied Decimal  @map("discount_applied") @db.Decimal(8,2)
  finalPrice      Decimal  @map("final_price") @db.Decimal(8,2)

  // ‚úÖ ESTADOS Y VALIDEZ
  status    String    @default("ACTIVE") @db.VarChar(20) // ACTIVE, USED, EXPIRED, CANCELLED
  code      String    @unique @db.VarChar(50)
  usedAt    DateTime? @map("used_at")
  expiresAt DateTime  @map("expires_at")

  // ‚úÖ METADATA Y TRACKING
  notes         String? @db.Text
  usageLocation String? @map("usage_location") @db.VarChar(20)
  ipAddress     String? @map("ip_address") @db.VarChar(45)
  deviceInfo    String? @map("device_info") @db.Text // JSON

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  offer       Offer        @relation(fields: [offerId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointment Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)

  @@index([userId, status], map: "idx_offer_redemption_user")
  @@index([offerId, status], map: "idx_offer_redemption_offer")
  @@index([expiresAt], map: "idx_offer_redemption_expiry")
  @@index([code], map: "idx_offer_redemption_code")
  @@map("offer_redemptions")
}

// ============================================================================
// üèÜ MODELO REWARD TEMPLATE - PLANTILLAS DE RECOMPENSAS
// ============================================================================

/// Plantilla de recompensa para el sistema de gamificaci√≥n
/// Configurable por cl√≠nica con analytics de popularidad
model RewardTemplate {
  /// Identificador √∫nico de la plantilla
  id       String @id @default(cuid())
  clinicId String @map("clinic_id")

  // ‚úÖ INFORMACI√ìN B√ÅSICA
  name             String @db.VarChar(100)
  description      String @db.Text
  shortDescription String? @map("short_description") @db.VarChar(200)
  type             String @db.VarChar(30) // DISCOUNT, UPGRADE, FREE_SERVICE

  // ‚úÖ CONFIGURACI√ìN DEL VALOR
  value      Decimal @db.Decimal(8,2)
  valueType  String  @default("PERCENTAGE") @map("value_type") @db.VarChar(20)
  pointsCost Int     @map("points_cost")
  marginCost Decimal @map("margin_cost") @db.Decimal(8,2)

  // ‚úÖ RESTRICCIONES Y CONDICIONES
  conditions      String? @db.Text // JSON
  validityDays    Int     @default(30) @map("validity_days")
  maxUsesPerMonth Int     @default(10) @map("max_uses_per_month")
  maxUsesPerUser  Int     @default(1) @map("max_uses_per_user")
  minLoyaltyScore Int     @default(0) @map("min_loyalty_score")
  targetUserType  String? @map("target_user_type") @db.VarChar(20)

  // ‚úÖ TRATAMIENTOS APLICABLES
  applicableTreatments String? @map("applicable_treatments") @db.Text // JSON
  excludedTreatments   String? @map("excluded_treatments") @db.Text // JSON

  // ‚úÖ CONFIGURACI√ìN VISUAL
  iconName String  @map("icon_name") @db.VarChar(50)
  color    String? @db.VarChar(7)
  imageUrl String? @map("image_url") @db.Text
  badge    String? @db.VarChar(20)

  // ‚úÖ ANALYTICS Y OPTIMIZACI√ìN
  popularity     Decimal @default(0) @db.Decimal(5,4)
  conversionRate Decimal @default(0) @map("conversion_rate") @db.Decimal(5,4)
  seasonality    String? @db.Text // JSON

  // ‚úÖ ESTADOS Y CONFIGURACI√ìN
  isActive   Boolean @default(true) @map("is_active")
  isFeatured Boolean @default(false) @map("is_featured")
  isLimited  Boolean @default(false) @map("is_limited")

  // ‚úÖ CONFIGURACI√ìN AVANZADA
  autoAssign   Boolean @default(false) @map("auto_assign")
  stackable    Boolean @default(false)
  transferable Boolean @default(false)

  // ‚úÖ L√çMITES DE STOCK
  stockLimit     Int? @map("stock_limit")
  stockRemaining Int? @map("stock_remaining")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  clinic      Clinic             @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  redemptions RewardRedemption[]

  @@index([clinicId, isActive], map: "idx_reward_template_clinic")
  @@index([pointsCost, isActive], map: "idx_reward_template_cost")
  @@index([isFeatured, popularity], map: "idx_reward_template_featured")
  @@index([type, isActive], map: "idx_reward_template_type")
  @@map("reward_templates")
}

// ============================================================================
// üéÅ MODELO REWARD REDEMPTION - CANJES DE RECOMPENSAS
// ============================================================================

/// Canje individual de una recompensa por puntos de belleza
/// Sistema completo de gesti√≥n de cupones y transferencias
model RewardRedemption {
  /// Identificador √∫nico del canje
  id            String  @id @default(cuid())
  userId        String  @map("user_id")
  templateId    String  @map("template_id")
  appointmentId String? @map("appointment_id")

  // ‚úÖ INFORMACI√ìN DEL CANJE
  code           String  @unique @db.VarChar(50)
  status         String  @default("ACTIVE") @db.VarChar(20) // ACTIVE, USED, EXPIRED
  pointsUsed     Int     @map("points_used")
  discountAmount Decimal? @map("discount_amount") @db.Decimal(8,2)

  // ‚úÖ VALIDEZ Y USO
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")

  // ‚úÖ SISTEMA DE TRANSFERENCIA
  transferredTo String?   @map("transferred_to")
  transferredAt DateTime? @map("transferred_at")
  transferCode  String?   @map("transfer_code") @db.VarChar(20)

  // ‚úÖ METADATA DE USO
  notes         String? @db.Text
  usageLocation String? @map("usage_location") @db.VarChar(20)
  ipAddress     String? @map("ip_address") @db.VarChar(45)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  template    RewardTemplate @relation(fields: [templateId], references: [id])
  appointment Appointment?   @relation(fields: [appointmentId], references: [id])

  @@index([userId, status], map: "idx_reward_redemption_user")
  @@index([templateId], map: "idx_reward_redemption_template")
  @@index([expiresAt], map: "idx_reward_redemption_expiry")
  @@index([code], map: "idx_reward_redemption_code")
  @@map("reward_redemptions")
}

// ============================================================================
// üîî MODELO NOTIFICATION LOG - SISTEMA DE NOTIFICACIONES
// ============================================================================

/// Log completo de notificaciones enviadas con analytics
/// Tracking de engagement y optimizaci√≥n de comunicaciones
model NotificationLog {
  /// Identificador √∫nico de la notificaci√≥n
  id       String  @id @default(cuid())
  userId   String  @map("user_id")
  clinicId String? @map("clinic_id")

  // ‚úÖ TIPO Y CONTENIDO
  type     NotificationType
  category String? @db.VarChar(30)
  title    String @db.VarChar(200)
  body     String @db.Text
  imageUrl String? @map("image_url") @db.Text

  // ‚úÖ ESTADO DE ENTREGA
  sentAt      DateTime @default(now()) @map("sent_at")
  delivered   Boolean  @default(false)
  deliveredAt DateTime? @map("delivered_at")
  opened      Boolean  @default(false)
  openedAt    DateTime? @map("opened_at")
  clicked     Boolean  @default(false)
  clickedAt   DateTime? @map("clicked_at")

  // ‚úÖ CONFIGURACI√ìN T√âCNICA
  channel      String  @default("PUSH") @db.VarChar(10) // PUSH, EMAIL, SMS
  data         String? @db.Text // JSON adicional
  pushToken    String? @map("push_token") @db.Text
  platform     String? @db.VarChar(10) // ios, android
  deepLink     String? @map("deep_link") @db.Text

  // ‚úÖ GESTI√ìN DE ERRORES
  error        String? @db.Text
  retryCount   Int     @default(0) @map("retry_count")
  lastRetryAt  DateTime? @map("last_retry_at")

  // ‚úÖ CAMPA√ëA Y SEGMENTACI√ìN
  campaignId   String? @map("campaign_id") @db.VarChar(50)
  batchId      String? @map("batch_id") @db.VarChar(50)
  
  // ‚úÖ PERSONALIZACI√ìN
  isPersonalized Boolean @default(false) @map("is_personalized")
  userSegment    String? @map("user_segment") @db.VarChar(50)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type], map: "idx_notification_user_type")
  @@index([sentAt], map: "idx_notification_date")
  @@index([delivered, opened], map: "idx_notification_engagement")
  @@index([clinicId, type], map: "idx_notification_clinic")
  @@index([campaignId], map: "idx_notification_campaign")
  @@map("notification_logs")
}

// ============================================================================
// üë• MODELO INVITATION - SISTEMA DE REFERIDOS
// ============================================================================

/// Sistema de invitaciones y referidos con tracking completo
/// Gamificaci√≥n de adquisici√≥n de nuevos clientes
model Invitation {
  /// Identificador √∫nico de la invitaci√≥n
  id           String  @id @default(cuid())
  inviterId    String  @map("inviter_id")
  clinicId     String  @map("clinic_id")
  inviteeEmail String  @map("invitee_email") @db.VarChar(100)
  inviteeName  String? @map("invitee_name") @db.VarChar(100)

  // ‚úÖ ESTADO Y RECOMPENSAS
  status       String @default("PENDING") @db.VarChar(20) // PENDING, ACCEPTED, EXPIRED
  rewardPoints Int    @default(50) @map("reward_points")
  bonusPoints  Int    @default(0) @map("bonus_points")

  // ‚úÖ VALIDEZ Y ACEPTACI√ìN
  expiresAt  DateTime  @map("expires_at")
  acceptedAt DateTime? @map("accepted_at")
  acceptedBy String?   @map("accepted_by") // User ID que acept√≥

  // ‚úÖ PERSONALIZACI√ìN Y COMUNICACI√ìN
  message      String? @db.Text
  inviteCode   String  @unique @map("invite_code") @db.VarChar(20)
  shareChannel String? @map("share_channel") @db.VarChar(20) // EMAIL, SMS, WHATSAPP

  // ‚úÖ TRACKING DE ENGAGEMENT
  sentAt       DateTime? @map("sent_at")
  viewedAt     DateTime? @map("viewed_at")
  clickedAt    DateTime? @map("clicked_at")

  // ‚úÖ ANALYTICS
  conversionValue Decimal? @map("conversion_value") @db.Decimal(8,2)
  lifetimeValue   Decimal? @map("lifetime_value") @db.Decimal(10,2)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  inviter User @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@index([inviterId, status], map: "idx_invitation_inviter")
  @@index([inviteCode], map: "idx_invitation_code")
  @@index([expiresAt], map: "idx_invitation_expiry")
  @@index([inviteeEmail], map: "idx_invitation_email")
  @@index([clinicId, status], map: "idx_invitation_clinic")
  @@map("invitations")
}

// ============================================================================
// üí° MODELO WELLNESS TIP - CONSEJOS DE BIENESTAR
// ============================================================================

/// Sistema de consejos de bienestar con targeting inteligente
/// Content marketing personalizado por perfil de usuario
model WellnessTip {
  /// Identificador √∫nico del consejo
  id       String  @id @default(cuid())
  clinicId String? @map("clinic_id")

  // ‚úÖ CONTENIDO PRINCIPAL
  title    String @db.VarChar(100)
  content  String @db.Text
  excerpt  String? @db.VarChar(200)
  category String @db.VarChar(30) // skincare, nutrition, lifestyle, treatments

  // ‚úÖ TARGETING INTELIGENTE
  targetAge       String? @map("target_age") @db.VarChar(20)
  targetGender    String? @map("target_gender") @db.VarChar(20)
  targetSkinType  String? @map("target_skin_type") @db.VarChar(20)
  seasonality     String? @db.Text // JSON para estacionalidad
  loyaltyTier     String? @map("loyalty_tier") @db.VarChar(20)

  // ‚úÖ CONFIGURACI√ìN VISUAL
  iconName String  @map("icon_name") @db.VarChar(50)
  imageUrl String? @map("image_url") @db.Text
  color    String? @db.VarChar(7)
  videoUrl String? @map("video_url") @db.Text

  // ‚úÖ CONFIGURACI√ìN Y ESTADOS
  isActive   Boolean @default(true) @map("is_active")
  isFeatured Boolean @default(false) @map("is_featured")
  priority   Int     @default(1)
  difficulty String  @default("EASY") @db.VarChar(20) // EASY, MEDIUM, HARD

  // ‚úÖ ENGAGEMENT Y ANALYTICS
  views     Int @default(0)
  likes     Int @default(0)
  shares    Int @default(0)
  bookmarks Int @default(0)
  rating    Decimal? @db.Decimal(3,2)

  // ‚úÖ METADATA Y AUTOR√çA
  tags       String? @db.Text // JSON array
  authorName String? @map("author_name") @db.VarChar(100)
  sourceUrl  String? @map("source_url") @db.Text
  readTime   Int?    @map("read_time") // minutos estimados

  // ‚úÖ SEO Y MARKETING
  seoTitle       String? @map("seo_title") @db.VarChar(200)
  seoDescription String? @map("seo_description") @db.Text

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  publishedAt DateTime? @map("published_at")

  // Relaciones
  clinic Clinic? @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@index([clinicId, isActive], map: "idx_wellness_tip_clinic")
  @@index([category, isActive], map: "idx_wellness_tip_category")
  @@index([isFeatured, priority], map: "idx_wellness_tip_featured")
  @@index([publishedAt], map: "idx_wellness_tip_published")
  @@index([targetAge, targetGender], map: "idx_wellness_tip_targeting")
  @@map("wellness_tips")
}

// ============================================================================
// üìä √çNDICES ESTRAT√âGICOS PARA MARKETING Y ENGAGEMENT
// ============================================================================
// 
// 1. GESTI√ìN DE OFERTAS:
//    - idx_offer_validity: Para ofertas activas por fecha
//    - idx_offer_targeting: Para segmentaci√≥n de audiencias
//
// 2. SISTEMA DE RECOMPENSAS:
//    - idx_reward_template_cost: Para b√∫squeda por puntos requeridos
//    - idx_reward_redemption_expiry: Para gesti√≥n de vencimientos
//
// 3. NOTIFICACIONES Y ENGAGEMENT:
//    - idx_notification_engagement: Para analytics de apertura
//    - idx_notification_campaign: Para reportes de campa√±as
//
// 4. PROGRAMA DE REFERIDOS:
//    - idx_invitation_code: Para validaci√≥n de c√≥digos √∫nicos
//    - idx_invitation_clinic: Para analytics por cl√≠nica
//
// 5. CONTENT MARKETING:
//    - idx_wellness_tip_targeting: Para personalizaci√≥n de contenido
//    - idx_wellness_tip_featured: Para destacados y priorizados
//
// ============================================================================

// ============================================================================
// üîö FIN DEL M√ìDULO DE MARKETING
// ============================================================================
// Total de modelos: 7
// L√≠neas: ~290
// Funcionalidad: Sistema completo de marketing, gamificaci√≥n y engagement
// ============================================================================

// ============================================================================
// üìÅ M√ìDULO 8: 08-REVIEWS
// ============================================================================

// ============================================================================
// üìÅ REVIEWS - SISTEMA DE REVIEWS Y RATINGS CORREGIDO
// ============================================================================

model AppointmentReview {
  id            String @id @default(cuid())
  appointmentId String @unique @map("appointment_id")
  userId        String @map("user_id")
  professionalId String @map("professional_id")
  treatmentId   String @map("treatment_id")

  // Ratings (1-5)
  overallRating      Int @map("overall_rating")
  professionalRating Int @map("professional_rating")
  treatmentRating    Int @map("treatment_rating")
  facilityRating     Int @map("facility_rating")
  valueRating        Int @map("value_rating")

  // Review content
  title   String? @db.VarChar(100)
  comment String? @db.Text
  pros    String? @db.Text
  cons    String? @db.Text

  // Recommendation
  wouldRecommend Boolean @map("would_recommend")
  wouldReturn    Boolean @map("would_return")

  // Moderation
  isApproved Boolean @default(false) @map("is_approved")
  isVisible  Boolean @default(true) @map("is_visible")
  moderatedBy String? @map("moderated_by")
  moderatedAt DateTime? @map("moderated_at")

  // Metadata
  isAnonymous Boolean @default(false) @map("is_anonymous")
  helpfulVotes Int @default(0) @map("helpful_votes")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones corregidas con nombres espec√≠ficos
  appointment  Appointment  @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  user         User         @relation("UserAppointmentReviews", fields: [userId], references: [id], onDelete: Cascade)
  professional Professional @relation("ProfessionalAppointmentReviews", fields: [professionalId], references: [id], onDelete: Cascade)
  treatment    Treatment    @relation("TreatmentAppointmentReviews", fields: [treatmentId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_review_user")
  @@index([professionalId, isApproved], map: "idx_review_professional")
  @@index([treatmentId, isApproved], map: "idx_review_treatment")
  @@index([overallRating, isApproved], map: "idx_review_rating")
  @@map("appointment_reviews")
}

// ============================================================================
// üìÅ M√ìDULO 9: 09-SYSTEM
// ============================================================================

// ============================================================================
// üìä DOMINIO: SISTEMA - ANALYTICS, AUDIT Y CONFIGURACI√ìN
// ============================================================================
// Modelos incluidos: AuditLog, AnalyticsEvent, BusinessMetric, SystemConfig, FeatureFlag
// Dependencias: 02-auth.prisma (User, Professional), 03-clinic.prisma (Clinic)
// √öltima actualizaci√≥n: 2025-08-20
// ============================================================================

// ============================================================================
// üõ°Ô∏è MODELO AUDIT LOG - TRAZABILIDAD COMPLETA
// ============================================================================

/// Registro de auditor√≠a para compliance y seguridad
/// Trazabilidad completa de todas las acciones cr√≠ticas del sistema
model AuditLog {
  /// Identificador √∫nico del log
  id String @id @default(cuid())

  // ‚úÖ ACTOR QUE REALIZ√ì LA ACCI√ìN
  userId         String? @map("user_id")
  professionalId String? @map("professional_id")
  clinicId       String? @map("clinic_id")
  actorType      String  @map("actor_type") @db.VarChar(20) // USER, PROFESSIONAL, SYSTEM
  actorEmail     String? @map("actor_email") @db.VarChar(100)

  // ‚úÖ ACCI√ìN REALIZADA
  action     String @db.VarChar(50) // CREATE, UPDATE, DELETE, LOGIN, EXPORT
  resource   String @db.VarChar(50) // USER, APPOINTMENT, PAYMENT, TREATMENT
  resourceId String? @map("resource_id") @db.VarChar(50)

  // ‚úÖ DETALLES DE LA ACCI√ìN
  description String? @db.Text
  changes     String? @db.Text // JSON con cambios espec√≠ficos
  oldValues   String? @map("old_values") @db.Text // JSON valores anteriores
  newValues   String? @map("new_values") @db.Text // JSON valores nuevos

  // ‚úÖ CONTEXTO T√âCNICO
  ipAddress String? @map("ip_address") @db.VarChar(45)
  userAgent String? @map("user_agent") @db.Text
  platform  String? @db.VarChar(20)
  sessionId String? @map("session_id") @db.VarChar(50)

  // ‚úÖ METADATA CONTEXTUAL
  severity String  @default("INFO") @db.VarChar(10) // DEBUG, INFO, WARN, ERROR, CRITICAL
  category String? @db.VarChar(30) // SECURITY, BUSINESS, SYSTEM, GDPR
  tags     String? @db.Text // JSON array de tags para filtrado

  // ‚úÖ COMPLIANCE Y LEGAL
  gdprRelevant    Boolean @default(false) @map("gdpr_relevant")
  retentionPolicy String? @map("retention_policy") @db.VarChar(20)
  
  // ‚úÖ INFORMACI√ìN ADICIONAL DE SEGURIDAD
  riskLevel       String? @map("risk_level") @db.VarChar(10) // LOW, MEDIUM, HIGH
  requiresReview  Boolean @default(false) @map("requires_review")
  reviewedBy      String? @map("reviewed_by")
  reviewedAt      DateTime? @map("reviewed_at")

  // Timestamp inmutable
  createdAt DateTime @default(now()) @map("created_at")

  // ‚úÖ √çNDICES PARA QUERIES DE AUDITOR√çA
  @@index([userId, action], map: "idx_audit_user_action")
  @@index([professionalId, action], map: "idx_audit_professional_action")
  @@index([clinicId, action], map: "idx_audit_clinic_action")
  @@index([resource, resourceId], map: "idx_audit_resource")
  @@index([createdAt], map: "idx_audit_date")
  @@index([severity, category], map: "idx_audit_severity")
  @@index([gdprRelevant], map: "idx_audit_gdpr")
  @@index([riskLevel, requiresReview], map: "idx_audit_security")
  @@map("audit_logs")
}

// ============================================================================
// üìà MODELO ANALYTICS EVENT - EVENTOS DE USUARIO
// ============================================================================

/// Evento de analytics para tracking de comportamiento
/// Sistema completo de analytics con contexto enriquecido
model AnalyticsEvent {
  /// Identificador √∫nico del evento
  id       String @id @default(cuid())
  userId   String? @map("user_id")
  clinicId String? @map("clinic_id")
  sessionId String? @map("session_id") @db.VarChar(50)

  // ‚úÖ INFORMACI√ìN DEL EVENTO
  eventName String @map("event_name") @db.VarChar(50)
  eventType String @map("event_type") @db.VarChar(30) // USER_ACTION, SYSTEM_EVENT, BUSINESS
  category  String? @db.VarChar(30)

  // ‚úÖ PROPIEDADES DEL EVENTO
  properties String? @db.Text // JSON con propiedades espec√≠ficas
  value      Decimal? @db.Decimal(10,2) // Valor monetario si aplica
  
  // ‚úÖ CONTEXTO DEL USUARIO
  userType      String? @map("user_type") @db.VarChar(20)
  loyaltyTier   String? @map("loyalty_tier") @db.VarChar(20)
  isVip         Boolean? @map("is_vip")
  userSegment   String? @map("user_segment") @db.VarChar(30)

  // ‚úÖ CONTEXTO T√âCNICO
  platform      String? @db.VarChar(20)
  deviceType    String? @map("device_type") @db.VarChar(20)
  appVersion    String? @map("app_version") @db.VarChar(20)
  screenName    String? @map("screen_name") @db.VarChar(50)

  // ‚úÖ CONTEXTO TEMPORAL
  dayOfWeek     Int? @map("day_of_week") // 1-7
  hourOfDay     Int? @map("hour_of_day") // 0-23
  isWeekend     Boolean? @map("is_weekend")
  timeZone      String? @map("time_zone") @db.VarChar(50)

  // ‚úÖ GEOLOCALIZACI√ìN
  country       String? @db.VarChar(2)
  city          String? @db.VarChar(50)
  ipAddress     String? @map("ip_address") @db.VarChar(45)

  // ‚úÖ CONTEXTO DE NEGOCIO
  funnel        String? @db.VarChar(30) // ACQUISITION, ACTIVATION, RETENTION
  touchpoint    String? @db.VarChar(30) // APP, EMAIL, SMS, WEB
  campaign      String? @db.VarChar(50)
  source        String? @db.VarChar(30)
  medium        String? @db.VarChar(30)

  // Timestamp
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, eventName], map: "idx_analytics_user_event")
  @@index([clinicId, eventName], map: "idx_analytics_clinic_event")
  @@index([eventName, createdAt], map: "idx_analytics_event_time")
  @@index([createdAt], map: "idx_analytics_date")
  @@index([userSegment, eventType], map: "idx_analytics_segment")
  @@index([funnel, touchpoint], map: "idx_analytics_funnel")
  @@map("analytics_events")
}

// ============================================================================
// üìä MODELO BUSINESS METRICS - M√âTRICAS DE NEGOCIO
// ============================================================================

/// M√©tricas agregadas de negocio para reporting ejecutivo
/// KPIs consolidados por per√≠odo para an√°lisis de tendencias
model BusinessMetric {
  /// Identificador √∫nico de la m√©trica
  id       String @id @default(cuid())
  clinicId String @map("clinic_id")
  
  // ‚úÖ PER√çODO DE MEDICI√ìN
  metricDate   DateTime @map("metric_date") @db.Date
  metricPeriod String   @map("metric_period") @db.VarChar(10) // DAILY, WEEKLY, MONTHLY
  
  // ‚úÖ M√âTRICAS DE CITAS
  totalAppointments     Int @default(0) @map("total_appointments")
  completedAppointments Int @default(0) @map("completed_appointments")
  cancelledAppointments Int @default(0) @map("cancelled_appointments")
  noShowAppointments    Int @default(0) @map("no_show_appointments")
  
  // ‚úÖ M√âTRICAS DE REVENUE
  totalRevenue      Decimal @default(0) @map("total_revenue") @db.Decimal(10,2)
  vipRevenue        Decimal @default(0) @map("vip_revenue") @db.Decimal(10,2)
  avgRevenuePerUser Decimal @default(0) @map("avg_revenue_per_user") @db.Decimal(8,2)
  avgOrderValue     Decimal @default(0) @map("avg_order_value") @db.Decimal(8,2)
  
  // ‚úÖ M√âTRICAS DE USUARIOS
  newUsers       Int @default(0) @map("new_users")
  activeUsers    Int @default(0) @map("active_users")
  returningUsers Int @default(0) @map("returning_users")
  churnedUsers   Int @default(0) @map("churned_users")
  
  // ‚úÖ M√âTRICAS DE CONVERSI√ìN
  signupConversion   Decimal @default(0) @map("signup_conversion") @db.Decimal(5,4)
  bookingConversion  Decimal @default(0) @map("booking_conversion") @db.Decimal(5,4)
  vipConversion      Decimal @default(0) @map("vip_conversion") @db.Decimal(5,4)
  retentionRate      Decimal @default(0) @map("retention_rate") @db.Decimal(5,4)
  
  // ‚úÖ M√âTRICAS DE SATISFACCI√ìN
  avgRating          Decimal? @map("avg_rating") @db.Decimal(3,2)
  npsScore           Decimal? @map("nps_score") @db.Decimal(5,2)
  reviewCount        Int @default(0) @map("review_count")
  satisfactionScore  Decimal? @map("satisfaction_score") @db.Decimal(3,2)
  
  // ‚úÖ M√âTRICAS OPERACIONALES
  utilizationRate    Decimal @default(0) @map("utilization_rate") @db.Decimal(5,4)
  punctualityRate    Decimal @default(0) @map("punctuality_rate") @db.Decimal(5,4)
  professionalEfficiency Decimal @default(0) @map("professional_efficiency") @db.Decimal(5,4)
  
  // ‚úÖ M√âTRICAS DE MARKETING
  acquisitionCost    Decimal @default(0) @map("acquisition_cost") @db.Decimal(8,2)
  marketingROI       Decimal @default(0) @map("marketing_roi") @db.Decimal(8,4)
  referralRate       Decimal @default(0) @map("referral_rate") @db.Decimal(5,4)
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@unique([clinicId, metricDate, metricPeriod], map: "unique_clinic_metric_period")
  @@index([clinicId, metricPeriod], map: "idx_clinic_metrics")
  @@index([metricDate], map: "idx_metric_date")
  @@index([metricPeriod, metricDate], map: "idx_metric_period_date")
  @@map("business_metrics")
}

// ============================================================================
// üîß MODELO SYSTEM CONFIG - CONFIGURACI√ìN DEL SISTEMA
// ============================================================================

/// Configuraci√≥n global del sistema con validaci√≥n
/// Permite configurar comportamientos sin deployments
model SystemConfig {
  /// Identificador √∫nico de la configuraci√≥n
  id    String @id @default(cuid())
  key   String @unique @db.VarChar(100)
  value String @db.Text
  type  String @db.VarChar(20) // STRING, NUMBER, BOOLEAN, JSON
  
  // ‚úÖ METADATA DESCRIPTIVA
  description String? @db.Text
  category    String? @db.VarChar(30)
  isPublic    Boolean @default(false) @map("is_public")
  isEditable  Boolean @default(true) @map("is_editable")
  
  // ‚úÖ VALIDACI√ìN Y CONSTRAINTS
  validationRules String? @map("validation_rules") @db.Text // JSON
  defaultValue    String? @map("default_value") @db.Text
  allowedValues   String? @map("allowed_values") @db.Text // JSON array
  
  // ‚úÖ CONFIGURACI√ìN DE ENTORNO
  environment     String @default("production") @db.VarChar(20)
  requiresRestart Boolean @default(false) @map("requires_restart")
  
  // ‚úÖ AUDIT Y TRACKING
  lastModifiedBy  String? @map("last_modified_by")
  changeReason    String? @map("change_reason") @db.Text
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@index([category], map: "idx_config_category")
  @@index([isPublic], map: "idx_config_public")
  @@index([environment], map: "idx_config_environment")
  @@map("system_configs")
}

// ============================================================================
// üö© MODELO FEATURE FLAG - CONTROL DE FEATURES
// ============================================================================

/// Sistema de feature flags para releases graduales
/// Control granular de funcionalidades por segmento de usuarios
model FeatureFlag {
  /// Identificador √∫nico del feature flag
  id          String @id @default(cuid())
  name        String @unique @db.VarChar(100)
  description String? @db.Text
  
  // ‚úÖ ESTADO Y CONFIGURACI√ìN
  isEnabled   Boolean @default(false) @map("is_enabled")
  environment String  @default("production") @db.VarChar(20)
  
  // ‚úÖ TARGETING GRANULAR
  targetUsers    String? @map("target_users") @db.Text // JSON array de user IDs
  targetClinics  String? @map("target_clinics") @db.Text // JSON array de clinic IDs
  targetPercent  Int?    @map("target_percent") // % de usuarios
  targetSegments String? @map("target_segments") @db.Text // JSON array
  
  // ‚úÖ CONFIGURACI√ìN AVANZADA
  config      String? @db.Text // JSON con configuraci√≥n espec√≠fica
  constraints String? @db.Text // JSON con constraints
  rolloutStrategy String? @map("rollout_strategy") @db.VarChar(20) // INSTANT, GRADUAL, CANARY
  
  // ‚úÖ VALIDEZ TEMPORAL
  validFrom   DateTime? @map("valid_from")
  validUntil  DateTime? @map("valid_until")
  
  // ‚úÖ ANALYTICS Y TRACKING
  usageCount     Int @default(0) @map("usage_count")
  lastUsedAt     DateTime? @map("last_used_at")
  conversionRate Decimal? @map("conversion_rate") @db.Decimal(5,4)
  
  // ‚úÖ METADATA Y OWNERSHIP
  owner       String? @db.VarChar(100)
  team        String? @db.VarChar(50)
  tags        String? @db.Text // JSON array
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@index([isEnabled, environment], map: "idx_feature_flag_enabled")
  @@index([validFrom, validUntil], map: "idx_feature_flag_validity")
  @@index([owner, team], map: "idx_feature_flag_ownership")
  @@map("feature_flags")
}

// ============================================================================
// üìä √çNDICES ESTRAT√âGICOS PARA SISTEMA Y ANALYTICS
// ============================================================================
// 
// 1. AUDITOR√çA Y COMPLIANCE:
//    - idx_audit_gdpr: Para reportes de compliance GDPR
//    - idx_audit_security: Para eventos de seguridad cr√≠ticos
//    - idx_audit_resource: Para trazabilidad por entidad
//
// 2. ANALYTICS Y BUSINESS INTELLIGENCE:
//    - idx_analytics_segment: Para an√°lisis por segmento de usuario
//    - idx_analytics_funnel: Para an√°lisis de embudo de conversi√≥n
//    - idx_metric_period_date: Para reportes ejecutivos
//
// 3. CONFIGURACI√ìN Y FEATURE FLAGS:
//    - idx_config_environment: Para configuraciones por entorno
//    - idx_feature_flag_enabled: Para evaluaci√≥n r√°pida de flags
//
// 4. PERFORMANCE CR√çTICA:
//    - idx_audit_date: Para limpieza de logs antiguos
//    - idx_analytics_date: Para particionado temporal
//
// QUERIES OPTIMIZADAS:
// - Reportes de auditor√≠a por usuario/acci√≥n
// - M√©tricas de negocio por per√≠odo
// - Evaluaci√≥n de feature flags
// - Analytics de comportamiento de usuario
// - Configuraci√≥n din√°mica del sistema
//
// ============================================================================

// ============================================================================
// üîö FIN DEL M√ìDULO DE SISTEMA
// ============================================================================
// Total de modelos: 5
// L√≠neas: ~280
// Funcionalidad: Analytics completo, auditor√≠a, configuraci√≥n y feature flags
// ============================================================================
